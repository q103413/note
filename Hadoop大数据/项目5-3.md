# åŸºäºHiveå®ç°ç”µå½±ç½‘ç«™ç”¨æˆ·å½±è¯„åˆ†æ - å®Œæ•´å®æ“æ•™ç¨‹

## ğŸ“š æ•™ç¨‹æ¦‚è¿°

æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»é›¶å¼€å§‹æ­å»ºHiveæ•°æ®ä»“åº“ï¼Œå¹¶é€šè¿‡ç”µå½±ç”¨æˆ·å½±è¯„æ•°æ®åˆ†æé¡¹ç›®ï¼ŒæŒæ¡Hiveçš„å®Œæ•´æ“ä½œæµç¨‹ã€‚æ•™ç¨‹æ³¨é‡å®é™…æ“ä½œï¼Œæ¯ä¸ªæ­¥éª¤éƒ½é…æœ‰è¯¦ç»†çš„å‘½ä»¤å’Œè¯´æ˜ã€‚

------

## ç¬¬ä¸€éƒ¨åˆ†ï¼šHiveåŸºç¡€çŸ¥è¯†

### 1.1 ä¸ºä»€ä¹ˆé€‰æ‹©Hiveï¼Ÿ

**ä¼ ç»Ÿæ•°æ®åº“çš„å±€é™ï¼š**

- âŒ æ— æ³•æ»¡è¶³æµ·é‡æ•°æ®å­˜å‚¨éœ€æ±‚
- âŒ éš¾ä»¥å¤„ç†å¤šç§ç±»å‹çš„æ•°æ®
- âŒ è®¡ç®—å’Œå¤„ç†èƒ½åŠ›ä¸è¶³

**Hiveçš„ä¼˜åŠ¿ï¼š**

- âœ… åŸºäºHadoopï¼Œå¯å¤„ç†PBçº§æ•°æ®
- âœ… ä½¿ç”¨ç±»SQLè¯­è¨€ï¼ˆHQLï¼‰ï¼Œå­¦ä¹ æˆæœ¬ä½
- âœ… æ”¯æŒå¤šç§æ•°æ®æºï¼ˆHDFSã€HBaseç­‰ï¼‰
- âœ… è‰¯å¥½çš„æ‰©å±•æ€§

### 1.2 Hive vs ä¼ ç»Ÿæ•°æ®åº“

| å¯¹æ¯”é¡¹   | Hive             | ä¼ ç»Ÿæ•°æ®åº“         |
| -------- | ---------------- | ------------------ |
| æŸ¥è¯¢è¯­è¨€ | HQL              | SQL                |
| æ•°æ®å­˜å‚¨ | HDFS             | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ       |
| æ‰§è¡Œå»¶è¿Ÿ | é«˜ï¼ˆé€‚åˆæ‰¹å¤„ç†ï¼‰ | ä½ï¼ˆé€‚åˆå®æ—¶æŸ¥è¯¢ï¼‰ |
| æ•°æ®è§„æ¨¡ | å¤§ï¼ˆTB/PBçº§ï¼‰    | å°ï¼ˆGBçº§ï¼‰         |
| ç´¢å¼•æ”¯æŒ | æœ‰é™             | å®Œå–„               |

------

## ç¬¬äºŒéƒ¨åˆ†ï¼šHiveç¯å¢ƒæ­å»ºï¼ˆå®æ“ï¼‰

### 2.1 å‡†å¤‡å·¥ä½œ

**ç¯å¢ƒè¦æ±‚ï¼š**

- Linuxç³»ç»Ÿï¼ˆCentOS 7æ¨èï¼‰
- Hadoop 3.3.6å·²å®‰è£…å¹¶æ­£å¸¸è¿è¡Œ
- JDK 1.8+
- MySQL 8.0+ï¼ˆç”¨äºå­˜å‚¨å…ƒæ•°æ®ï¼‰

### 2.2 å®‰è£…Hiveï¼ˆç›´è¿æ•°æ®åº“æ¨¡å¼ï¼‰

#### Step 1: ä¸‹è½½å¹¶ä¸Šä¼ Hiveå®‰è£…åŒ…

```bash
# åœ¨Linuxç³»ç»Ÿä¸­åˆ›å»ºç›®å½•
mkdir -p /opt/apps
cd /opt/apps

# ä½¿ç”¨Xftpæˆ–scpä¸Šä¼  apache-hive-3.1.3-bin.tar.gz
# è§£å‹åˆ°/usr/localç›®å½•
tar -zxvf apache-hive-3.1.3-bin.tar.gz -C /usr/local/
```

#### Step 2: è§£å†³JaråŒ…å†²çª

```bash
cd /usr/local/apache-hive-3.1.3-bin/lib

# åˆ é™¤ä½ç‰ˆæœ¬guava
rm -f guava-19.0.jar

# å¤åˆ¶Hadoopçš„guavaåŒ…
cp /usr/local/hadoop-3.3.6/share/hadoop/common/lib/guava-27.0-jre.jar .

# åˆ é™¤å†²çªçš„æ—¥å¿—åŒ…
rm -f log4j-slf4j-impl-2.17.1.jar
```

#### Step 3: é…ç½®ç¯å¢ƒå˜é‡

```bash
# ç¼–è¾‘profileæ–‡ä»¶
vim /etc/profile

# æ·»åŠ ä»¥ä¸‹å†…å®¹
export HIVE_HOME=/usr/local/apache-hive-3.1.3-bin
export PATH=$PATH:$HIVE_HOME/bin

# ä½¿é…ç½®ç”Ÿæ•ˆ
source /etc/profile
```

#### Step 4: å®‰è£…MySQL

```bash
# æ£€æŸ¥å¹¶å¸è½½MariaDB
rpm -qa | grep mariadb
rpm -e --nodeps mariadb-libs

# æŒ‰é¡ºåºå®‰è£…MySQL RPMåŒ…
rpm -ivh mysql-community-common-8.0.21-1.el7.x86_64.rpm
rpm -ivh mysql-community-libs-8.0.21-1.el7.x86_64.rpm
rpm -ivh mysql-community-client-8.0.21-1.el7.x86_64.rpm
rpm -ivh mysql-community-server-8.0.21-1.el7.x86_64.rpm
```

#### Step 5: é…ç½®MySQL

```bash
# ç¼–è¾‘MySQLé…ç½®æ–‡ä»¶
vim /etc/my.cnf

# åœ¨[mysqld]ä¸‹æ·»åŠ 
character-set-server=utf8
collation-server=utf8_general_ci

# å¯åŠ¨MySQL
systemctl start mysqld

# æŸ¥çœ‹åˆå§‹å¯†ç 
grep 'temporary password' /var/log/mysqld.log

# ç™»å½•MySQL
mysql -u root -p

# ä¿®æ”¹å¯†ç ï¼ˆå¯†ç ç­–ç•¥ï¼šå¤§å°å†™å­—æ¯+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ï¼‰
ALTER USER 'root'@'localhost' IDENTIFIED BY 'YourPassword@123';

# è®¾ç½®è¿œç¨‹è®¿é—®æƒé™
CREATE USER 'root'@'%' IDENTIFIED BY 'YourPassword@123';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;

# è®¾ç½®å¼€æœºå¯åŠ¨
systemctl enable mysqld
```

#### Step 6: é…ç½®Hiveè¿æ¥MySQL

```xml
# åˆ›å»ºhive-site.xmlé…ç½®æ–‡ä»¶
cd /usr/local/apache-hive-3.1.3-bin/conf
vim hive-site.xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
    <property>
       <name>hive.support.concurrency</name>
       <value>true</value>
    </property>
    <property>
       <name>hive.enforce.bucketing</name>
       <value>true</value>
    </property>
    <property>
       <name>hive.exec.dynamic.partition.mode</name>
       <value>nonstrict</value>
    </property>
    <property>
       <name>hive.txn.manager</name>
       <value>org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</value>
    </property>
    <property>
       <name>hive.compactor.initiator.on</name>
       <value>true</value>
    </property>
    <property>
       <name>hive.compactor.worker.threads</name>
       <value>1</value>
    </property>
    <property>
       <name>hive.in.test</name>
       <value>true</value>
    </property>

      <property>
         <name>hive.metastore.warehouse.dir</name>
         <value>hdfs://master:8020/user/hive/warehouse</value>
      </property>
      <property>
         <name>javax.jdo.option.ConnectionURL</name>
         <value>
         jdbc:mysql://192.168.128.130:3306/hive?createDatabaseIfNotExist=true
         </value>
         <description>MySQLè¿æ¥åè®®</description>
      </property>
      <property>
         <name>javax.jdo.option.ConnectionDriverName</name>
         <value>com.mysql.cj.jdbc.Driver</value>
         <description>JDBCè¿æ¥é©±åŠ¨</description>
      </property>
      <property>
         <name>javax.jdo.option.ConnectionUserName</name>
         <value>root</value>
         <description>ç”¨æˆ·å</description>
      </property>
      <property>
         <name>javax.jdo.option.ConnectionPassword</name>
         <value>123456</value>
         <description>å¯†ç </description>
      </property>
</configuration>
```

#### Step 7: ä¸Šä¼ MySQLé©±åŠ¨å¹¶åˆå§‹åŒ–å…ƒæ•°æ®

```bash
# ä¸‹è½½MySQL JDBCé©±åŠ¨
# mysql-connector-java-8.0.21.jar

# å¤åˆ¶åˆ°Hiveçš„libç›®å½•
cp mysql-connector-java-8.0.21.jar /usr/local/apache-hive-3.1.3-bin/lib/

# åˆå§‹åŒ–å…ƒæ•°æ®åº“
schematool -dbType mysql -initSchema
```

#### Step 8: å¯åŠ¨Hive

```bash
# ç¡®ä¿Hadoopé›†ç¾¤å·²å¯åŠ¨
start-all.sh

# å¯åŠ¨Hive
hive

# æˆåŠŸè¿›å…¥Hiveå‘½ä»¤è¡Œç•Œé¢
hive> show databases;
```

------

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šHiveæ•°æ®åº“å’Œè¡¨æ“ä½œ

### 3.1 æ•°æ®åº“æ“ä½œ

#### åˆ›å»ºæ•°æ®åº“

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS myhive
COMMENT 'ç”µå½±åˆ†ææ•°æ®åº“'
LOCATION '/user/hive/warehouse/myhive.db';

-- æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“
SHOW DATABASES;

-- æŸ¥çœ‹æ•°æ®åº“è¯¦æƒ…
DESCRIBE DATABASE EXTENDED myhive;

-- ä½¿ç”¨æ•°æ®åº“
USE myhive;
```

#### ä¿®æ”¹æ•°æ®åº“

```sql
-- ä¿®æ”¹æ•°æ®åº“å±æ€§
ALTER DATABASE myhive SET DBPROPERTIES('creator'='admin', 'date'='2024-01-01');

-- ä¿®æ”¹æ•°æ®åº“ä½ç½®ï¼ˆæ³¨æ„ï¼šä¸ä¼šç§»åŠ¨å·²æœ‰æ•°æ®ï¼‰
ALTER DATABASE myhive SET LOCATION '/user/hive/warehouse/new_myhive.db';
```

#### åˆ é™¤æ•°æ®åº“

```sql
-- åˆ é™¤ç©ºæ•°æ®åº“
DROP DATABASE IF EXISTS myhive;

-- å¼ºåˆ¶åˆ é™¤ï¼ˆåŒ…å«è¡¨çš„æ•°æ®åº“ï¼‰
DROP DATABASE IF EXISTS myhive CASCADE;
```

### 3.2 è¡¨æ“ä½œå®æˆ˜

#### 3.2.1 åˆ›å»ºå†…éƒ¨è¡¨

```sql
-- ä½¿ç”¨myhiveæ•°æ®åº“
USE myhive;

-- åˆ›å»ºç®€å•å†…éƒ¨è¡¨
CREATE TABLE IF NOT EXISTS user_info(
    id INT COMMENT 'ç”¨æˆ·ID',
    name STRING COMMENT 'ç”¨æˆ·å§“å'
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯è¡¨'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE FORMATTED user_info;
```

#### 3.2.2 åˆ›å»ºå¤–éƒ¨è¡¨

**å‡†å¤‡æ•°æ®æ–‡ä»¶ student_info.txtï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼‰ï¼š**

```
2021513501	å¼ æ™“å¨Ÿ	å¥³	153*****506	2021çº§ä¿¡ç®¡1ç­
2021513505	æå°é¹	ç”·	156*****501	2021çº§ä¿¡ç®¡2ç­
2021513503	å¼ ä¸½	å¥³	186*****556	2021çº§ä¿¡ç®¡1ç­
```

**ä¸Šä¼ åˆ°HDFSï¼š**

```bash
# åˆ›å»ºHDFSç›®å½•
hdfs dfs -mkdir -p /stu

# ä¸Šä¼ æ•°æ®æ–‡ä»¶
hdfs dfs -put student_info.txt /stu/
```

**åˆ›å»ºå¤–éƒ¨è¡¨ï¼š**

```sql
CREATE EXTERNAL TABLE IF NOT EXISTS student_external(
    stu_no STRING COMMENT 'å­¦å·',
    stu_name STRING COMMENT 'å§“å',
    stu_sex STRING COMMENT 'æ€§åˆ«',
    telephone STRING COMMENT 'ç”µè¯',
    stu_class STRING COMMENT 'ç­çº§'
)
COMMENT 'å­¦ç”Ÿä¿¡æ¯å¤–éƒ¨è¡¨'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE
LOCATION '/stu';

-- æŸ¥è¯¢æ•°æ®éªŒè¯
SELECT * FROM student_external LIMIT 5;
```

**å†…éƒ¨è¡¨ vs å¤–éƒ¨è¡¨çš„åŒºåˆ«ï¼š**

- **å†…éƒ¨è¡¨**ï¼šåˆ é™¤è¡¨æ—¶ï¼Œå…ƒæ•°æ®å’ŒHDFSä¸Šçš„æ•°æ®éƒ½ä¼šè¢«åˆ é™¤
- **å¤–éƒ¨è¡¨**ï¼šåˆ é™¤è¡¨æ—¶ï¼Œåªåˆ é™¤å…ƒæ•°æ®ï¼ŒHDFSä¸Šçš„æ•°æ®ä¿ç•™

#### 3.2.3 åˆ›å»ºåˆ†åŒºè¡¨

```sql
-- åˆ›å»ºå•åˆ†åŒºè¡¨
CREATE TABLE IF NOT EXISTS stu_score(
    sno STRING COMMENT 'å­¦å·',
    course STRING COMMENT 'è¯¾ç¨‹',
    score INT COMMENT 'æˆç»©'
)
COMMENT 'å­¦ç”Ÿæˆç»©è¡¨'
PARTITIONED BY (class_name STRING COMMENT 'ç­çº§')
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- æ·»åŠ åˆ†åŒº
ALTER TABLE stu_score ADD PARTITION(class_name='07111301');
ALTER TABLE stu_score ADD PARTITION(class_name='07111302');

-- æŸ¥çœ‹åˆ†åŒº
SHOW PARTITIONS stu_score;

-- åˆ é™¤åˆ†åŒº
ALTER TABLE stu_score DROP IF EXISTS PARTITION(class_name='07111302');
```

**åˆ›å»ºå¤šçº§åˆ†åŒºè¡¨ï¼š**

```sql
CREATE TABLE IF NOT EXISTS orders(
    order_id STRING,
    user_id STRING,
    amount DOUBLE
)
PARTITIONED BY (year STRING, month STRING, day STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t';

-- æ·»åŠ å¤šçº§åˆ†åŒº
ALTER TABLE orders ADD PARTITION(year='2024', month='01', day='15');
```

#### 3.2.4 åˆ›å»ºåˆ†æ¡¶è¡¨

```sql
-- åˆ›å»ºåˆ†æ¡¶è¡¨
CREATE TABLE IF NOT EXISTS student_bucket(
    sno STRING,
    sname STRING,
    age INT
)
COMMENT 'å­¦ç”Ÿåˆ†æ¡¶è¡¨'
CLUSTERED BY (sno) INTO 4 BUCKETS
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- è®¾ç½®åˆ†æ¡¶å±æ€§
SET hive.enforce.bucketing = true;
```

### 3.3 ä¿®æ”¹è¡¨æ“ä½œ

```sql
-- é‡å‘½åè¡¨
ALTER TABLE score RENAME TO stu_score;

-- æ·»åŠ åˆ—
ALTER TABLE stu_score ADD COLUMNS (
    credit FLOAT COMMENT 'å­¦åˆ†',
    gpa FLOAT COMMENT 'ç»©ç‚¹'
);

-- ä¿®æ”¹åˆ—
ALTER TABLE stu_score CHANGE COLUMN credit Credits FLOAT COMMENT 'å­¦åˆ†';

-- æ›¿æ¢æ‰€æœ‰åˆ—ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
ALTER TABLE stu_score REPLACE COLUMNS (
    sno STRING,
    course STRING,
    score INT
);

-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE EXTENDED stu_score;
```

------

## ç¬¬å››éƒ¨åˆ†ï¼šæ•°æ®æ“ä½œå®æˆ˜

### 4.1 æ•°æ®è£…è½½

#### å‡†å¤‡æµ‹è¯•æ•°æ®

**student.txtï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼‰ï¼š**

```
2018213201	æå°å‹‡	ç”·	20	CS
2018213202	åˆ˜è‰¯	å¥³	19	IS
2018213203	ç‹èŠèŠ	å¥³	22	MA
2018213204	å¼ å¤§ç«‹	ç”·	19	IS
2018213205	åˆ˜äº‘å±±	ç”·	18	MA
```

**course.txtï¼š**

```
1	Pythonè¯­è¨€ç¨‹åºè®¾è®¡
2	æ•°æ®åº“ç³»ç»ŸåŸç†
3	ä¿¡æ¯ç³»ç»Ÿåˆ†æä¸è®¾è®¡
4	å¤§æ•°æ®æŠ€æœ¯åŠåº”ç”¨
5	Hadoopå¼€å‘ä¸åº”ç”¨
```

**sc.txtï¼š**

```
2018213201	1	81
2018213201	2	85
2018213201	3	88
2018213202	2	90
2018213202	3	80
```

#### åˆ›å»ºè¡¨

```sql
-- å­¦ç”Ÿè¡¨
CREATE TABLE IF NOT EXISTS student(
    Sno STRING COMMENT 'å­¦å·',
    Sname STRING COMMENT 'å§“å',
    Ssex STRING COMMENT 'æ€§åˆ«',
    Sage INT COMMENT 'å¹´é¾„',
    Sdept STRING COMMENT 'ä¸“ä¸š'
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- è¯¾ç¨‹è¡¨
CREATE TABLE IF NOT EXISTS course(
    Cno INT COMMENT 'è¯¾ç¨‹ç¼–å·',
    Cname STRING COMMENT 'è¯¾ç¨‹åç§°'
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- æˆç»©è¡¨
CREATE TABLE IF NOT EXISTS sc(
    Sno STRING COMMENT 'å­¦å·',
    Cno INT COMMENT 'è¯¾ç¨‹ç¼–å·',
    Grade INT COMMENT 'æˆç»©'
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;
```

#### è£…è½½æ•°æ®

**æ–¹æ³•1ï¼šä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè£…è½½**

```sql
-- LOCALå…³é”®å­—è¡¨ç¤ºä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè¯»å–
LOAD DATA LOCAL INPATH '/opt/stu/student.txt' INTO TABLE student;
LOAD DATA LOCAL INPATH '/opt/stu/course.txt' INTO TABLE course;
LOAD DATA LOCAL INPATH '/opt/stu/sc.txt' INTO TABLE sc;
```

**æ–¹æ³•2ï¼šä»HDFSè£…è½½**

```bash
# å…ˆä¸Šä¼ åˆ°HDFS
hdfs dfs -put /opt/stu/*.txt /user/data/
-- ä¸åŠ LOCALå…³é”®å­—ï¼Œä»HDFSè¯»å–ï¼ˆä¼šç§»åŠ¨æ–‡ä»¶ï¼‰
LOAD DATA INPATH '/user/data/student.txt' INTO TABLE student;
```

**æ–¹æ³•3ï¼šOVERWRITEè¦†ç›–è£…è½½**

```sql
-- è¦†ç›–è¡¨ä¸­åŸæœ‰æ•°æ®
LOAD DATA LOCAL INPATH '/opt/stu/student.txt' OVERWRITE INTO TABLE student;
```

### 4.2 æŸ¥è¯¢æ“ä½œ

#### åŸºç¡€æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æ‰€æœ‰æ•°æ®
SELECT * FROM student;

-- æŸ¥è¯¢æŒ‡å®šåˆ—
SELECT Sno, Sname FROM student;

-- æ¡ä»¶æŸ¥è¯¢
SELECT Sno, Sname FROM student WHERE Ssex='ç”·';

-- å»é‡æŸ¥è¯¢
SELECT DISTINCT Sdept FROM student;

-- é™åˆ¶è¿”å›è¡Œæ•°
SELECT * FROM student LIMIT 5;
```

#### èšåˆæŸ¥è¯¢

```sql
-- ç»Ÿè®¡è®°å½•æ•°
SELECT COUNT(*) AS total FROM student;

-- æŒ‰ä¸“ä¸šç»Ÿè®¡äººæ•°
SELECT Sdept, COUNT(*) AS count 
FROM student 
GROUP BY Sdept;

-- è®¡ç®—å¹³å‡å¹´é¾„
SELECT AVG(Sage) AS avg_age FROM student;

-- æŸ¥æ‰¾æœ€é«˜åˆ†
SELECT MAX(Grade) AS max_grade FROM sc;
```

#### è¿æ¥æŸ¥è¯¢

```sql
-- å†…è¿æ¥ï¼šæŸ¥è¯¢å­¦ç”Ÿå§“åå’Œè¯¾ç¨‹åç§°
SELECT s.Sname, c.Cname, sc.Grade
FROM student s
JOIN sc ON s.Sno = sc.Sno
JOIN course c ON sc.Cno = c.Cno;

-- å·¦è¿æ¥ï¼šæ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿï¼ˆåŒ…æ‹¬æœªé€‰è¯¾çš„ï¼‰
SELECT s.Sno, s.Sname, c.Cname
FROM student s
LEFT JOIN sc ON s.Sno = sc.Sno
LEFT JOIN course c ON sc.Cno = c.Cno;
```

#### é«˜çº§æŸ¥è¯¢

```sql
-- HAVINGå­å¥ï¼šæŸ¥è¯¢é€‰ä¿®3é—¨ä»¥ä¸Šè¯¾ç¨‹çš„å­¦ç”Ÿ
SELECT Sno, COUNT(*) AS course_count
FROM sc
GROUP BY Sno
HAVING COUNT(*) > 3;

-- ORDER BYå…¨å±€æ’åº
SELECT * FROM student ORDER BY Sage ASC;

-- SORT BYåˆ†åŒºå†…æ’åºï¼ˆéœ€è¦å¤šä¸ªreducerï¼‰
SET mapred.reduce.tasks=2;
SELECT * FROM student SORT BY Sage ASC;

-- DISTRIBUTE BY + SORT BY
SELECT * FROM student
DISTRIBUTE BY Sdept
SORT BY Sage ASC;

-- CLUSTER BYï¼ˆç­‰åŒäºDISTRIBUTE BY + SORT BYåŒä¸€å­—æ®µï¼‰
SELECT * FROM student CLUSTER BY Sdept;
```

#### å­æŸ¥è¯¢

```sql
-- å­æŸ¥è¯¢ï¼šæŸ¥è¯¢æˆç»©é«˜äºå¹³å‡åˆ†çš„è®°å½•
SELECT Sno, Cno, Grade
FROM sc
WHERE Grade > (SELECT AVG(Grade) FROM sc);

-- INå­æŸ¥è¯¢ï¼šæŸ¥è¯¢é€‰ä¿®äº†Pythonè¯¾ç¨‹çš„å­¦ç”Ÿ
SELECT Sno, Sname
FROM student
WHERE Sno IN (
    SELECT Sno FROM sc WHERE Cno = 1
);
```

### 4.3 æ’å…¥æ“ä½œ

```sql
-- æ’å…¥å•æ¡æ•°æ®
INSERT INTO TABLE student VALUES
('2018213230', 'ç‹å°æ˜', 'ç”·', 20, 'CS');

-- æ’å…¥å¤šæ¡æ•°æ®
INSERT INTO TABLE student VALUES
('2018213231', 'æçº¢', 'å¥³', 19, 'IS'),
('2018213232', 'å¼ ä¼Ÿ', 'ç”·', 21, 'MA');

-- ä»æŸ¥è¯¢ç»“æœæ’å…¥
INSERT INTO TABLE student
SELECT * FROM student_external WHERE Sdept='CS';

-- è¦†ç›–æ’å…¥
INSERT OVERWRITE TABLE student
SELECT * FROM student_backup;

-- å¤šè¡¨æ’å…¥
FROM student
INSERT OVERWRITE TABLE student_cs SELECT * WHERE Sdept='CS'
INSERT OVERWRITE TABLE student_is SELECT * WHERE Sdept='IS';
```

### 4.4 æ›´æ–°å’Œåˆ é™¤æ“ä½œ

**æ³¨æ„ï¼šHiveé»˜è®¤ä¸æ”¯æŒUPDATEå’ŒDELETEï¼Œéœ€è¦é…ç½®äº‹åŠ¡è¡¨**

#### é…ç½®äº‹åŠ¡æ”¯æŒ

```bash
# ç¼–è¾‘hive-site.xml
vim /usr/local/apache-hive-3.1.3-bin/conf/hive-site.xml
<!-- æ·»åŠ ä»¥ä¸‹é…ç½® -->
<property>
    <name>hive.support.concurrency</name>
    <value>true</value>
</property>

<property>
    <name>hive.enforce.bucketing</name>
    <value>true</value>
</property>

<property>
    <name>hive.exec.dynamic.partition.mode</name>
    <value>nonstrict</value>
</property>

<property>
    <name>hive.txn.manager</name>
    <value>org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</value>
</property>

<property>
    <name>hive.compactor.initiator.on</name>
    <value>true</value>
</property>

<property>
    <name>hive.compactor.worker.threads</name>
    <value>1</value>
</property>
```

#### åˆ›å»ºäº‹åŠ¡è¡¨

```sql
-- åˆ›å»ºæ”¯æŒäº‹åŠ¡çš„ORCæ ¼å¼è¡¨
CREATE TABLE student_orc(
    Sno STRING,
    Sname STRING,
    Ssex STRING,
    Sage INT,
    Sdept STRING
)
CLUSTERED BY (Sno) INTO 2 BUCKETS
STORED AS ORC
TBLPROPERTIES ('transactional'='true');

-- ä»åŸè¡¨å¯¼å…¥æ•°æ®
INSERT INTO TABLE student_orc SELECT * FROM student;
```

#### æ‰§è¡Œæ›´æ–°å’Œåˆ é™¤

```sql
-- æ›´æ–°æ•°æ®
UPDATE student_orc 
SET Sage = 21 
WHERE Sno = '2018213201';

-- åˆ é™¤æ•°æ®
DELETE FROM student_orc 
WHERE Sno = '2018213230';

-- æ¸…ç©ºè¡¨ï¼ˆåˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¿ç•™è¡¨ç»“æ„ï¼‰
TRUNCATE TABLE student_orc;
```

------

## ç¬¬äº”éƒ¨åˆ†ï¼šç”µå½±ç”¨æˆ·å½±è¯„åˆ†æé¡¹ç›®å®æˆ˜

### 5.1 é¡¹ç›®èƒŒæ™¯

åˆ†æç”µå½±ç½‘ç«™çš„ç”¨æˆ·å½±è¯„æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ€§åˆ«ã€å¹´é¾„ã€èŒä¸šç­‰ï¼‰
- ç”µå½±ä¿¡æ¯ï¼ˆIDã€ç±»å‹ç­‰ï¼‰
- ç”¨æˆ·è¯„åˆ†è®°å½•

### 5.2 æ•°æ®å‡†å¤‡

#### æ•°æ®æ–‡ä»¶è¯´æ˜

**1. ratings.datï¼ˆè¯„åˆ†æ•°æ®ï¼Œåˆ†éš”ç¬¦`::`ï¼‰**

```
1::1193::5::978300760
1::661::3::978302109
1::914::3::978301968
```

å­—æ®µï¼šUserID::MovieID::Rating::Timestamp

**2. users.datï¼ˆç”¨æˆ·æ•°æ®ï¼Œåˆ†éš”ç¬¦`::`ï¼‰**

```
1::F::1::10::48067
2::M::56::16::70072
3::M::25::15::55117
```

å­—æ®µï¼šUserID::Gender::Age::Occupation::Zip-code

**3. movies.datï¼ˆç”µå½±æ•°æ®ï¼Œåˆ†éš”ç¬¦`::`ï¼‰**

```
1::Toy Story (1995)::Animation|Children's|Comedy
2::Jumanji (1995)::Adventure|Children's|Fantasy
3::Grumpier Old Men (1995)::Comedy|Romance
```

å­—æ®µï¼šMovieID::Title::Genres

### 5.3 åˆ›å»ºæ•°æ®åº“å’Œè¡¨

```sql
-- åˆ›å»ºç”µå½±åˆ†ææ•°æ®åº“
CREATE DATABASE IF NOT EXISTS film_analysis
COMMENT 'ç”µå½±ç”¨æˆ·å½±è¯„åˆ†ææ•°æ®åº“'
LOCATION '/user/hive/warehouse/film_analysis.db';

USE film_analysis;
```

#### åˆ›å»ºè¯„åˆ†è¡¨

```sql
CREATE TABLE IF NOT EXISTS film_ratings(
    UserID INT COMMENT 'ç”¨æˆ·ID',
    MovieID INT COMMENT 'ç”µå½±ID',
    Rating INT COMMENT 'è¯„åˆ†',
    ts BIGINT COMMENT 'æ—¶é—´æˆ³'
)
COMMENT 'ç”¨æˆ·è¯„åˆ†è¡¨'
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;
```

#### åˆ›å»ºç”¨æˆ·è¡¨

```sql
CREATE TABLE IF NOT EXISTS film_users(
    UserID INT COMMENT 'ç”¨æˆ·ID',
    Gender STRING COMMENT 'æ€§åˆ«',
    Age INT COMMENT 'å¹´é¾„æ®µ',
    Occupation INT COMMENT 'èŒä¸š',
    Zip_code STRING COMMENT 'é‚®æ”¿ç¼–ç '
)
COMMENT 'ç”¨æˆ·ä¿¡æ¯è¡¨'
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;
```

#### åˆ›å»ºç”µå½±è¡¨

```sql
CREATE TABLE IF NOT EXISTS film_movies(
    MovieID INT COMMENT 'ç”µå½±ID',
    Title STRING COMMENT 'ç”µå½±æ ‡é¢˜',
    Genres STRING COMMENT 'ç”µå½±ç±»å‹'
)
COMMENT 'ç”µå½±ä¿¡æ¯è¡¨'
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;
```

### 5.4 è£…è½½æ•°æ®

```bash
# ä¸Šä¼ æ•°æ®æ–‡ä»¶åˆ°HDFS
hdfs dfs -mkdir -p /user/film/data
hdfs dfs -put ratings.dat /user/film/data/
hdfs dfs -put users.dat /user/film/data/
hdfs dfs -put movies.dat /user/film/data/
-- è£…è½½æ•°æ®
LOAD DATA INPATH '/user/film/data/ratings.dat' INTO TABLE film_ratings;
LOAD DATA INPATH '/user/film/data/users.dat' INTO TABLE film_users;
LOAD DATA INPATH '/user/film/data/movies.dat' INTO TABLE film_movies;

-- éªŒè¯æ•°æ®
SELECT COUNT(*) FROM film_ratings;
SELECT COUNT(*) FROM film_users;
SELECT COUNT(*) FROM film_movies;

SELECT * FROM film_ratings LIMIT 5;
```

### 5.5 æ•°æ®åˆ†æä»»åŠ¡

#### ä»»åŠ¡1ï¼šç»Ÿè®¡è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±

```sql
-- åˆ›å»ºç»“æœè¡¨
CREATE TABLE IF NOT EXISTS top10_movies_by_ratings AS
SELECT 
    r.MovieID,
    m.Title,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY r.MovieID, m.Title
ORDER BY rating_count DESC
LIMIT 10;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM top10_movies_by_ratings;
```

#### ä»»åŠ¡2ï¼šç»Ÿè®¡ä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±

```sql
-- ç”·æ€§ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±
CREATE TABLE IF NOT EXISTS top10_movies_male AS
SELECT 
    m.Title,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE u.Gender = 'M'
GROUP BY m.MovieID, m.Title
HAVING COUNT(*) >= 50  -- è‡³å°‘50ä¸ªè¯„åˆ†
ORDER BY avg_rating DESC
LIMIT 10;

-- å¥³æ€§ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±
CREATE TABLE IF NOT EXISTS top10_movies_female AS
SELECT 
    m.Title,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE u.Gender = 'F'
GROUP BY m.MovieID, m.Title
HAVING COUNT(*) >= 50
ORDER BY avg_rating DESC
LIMIT 10;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM top10_movies_male;
SELECT * FROM top10_movies_female;
```

#### ä»»åŠ¡3ï¼šè®¡ç®—æŒ‡å®šç”µå½±å„å¹´é¾„æ®µç”¨æˆ·çš„å¹³å‡è¯„åˆ†

```sql
-- ä»¥ç”µå½±IDä¸º1ï¼ˆToy Storyï¼‰ä¸ºä¾‹
CREATE TABLE IF NOT EXISTS movie_ratings_by_age AS
SELECT 
    m.Title,
    u.Age,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE r.MovieID = 1
GROUP BY m.Title, u.Age
ORDER BY u.Age;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM movie_ratings_by_age;
```

#### ä»»åŠ¡4ï¼šç»Ÿè®¡å„ç±»å‹ç”µå½±ä¸­è¯„åˆ†æœ€é«˜çš„5éƒ¨

```sql
-- å…ˆå°†ç”µå½±ç±»å‹æ‹†åˆ†ï¼ˆå¤„ç†å¤šç±»å‹ç”µå½±ï¼‰
-- ä½¿ç”¨lateral view explodeæ‹†åˆ†ç±»å‹
CREATE TABLE IF NOT EXISTS top_movies_by_genre AS
SELECT 
    genre,
    Title,
    avg_rating,
    rating_count,
    row_num
FROM (
    SELECT 
        genre,
        m.Title,
        AVG(r.Rating) AS avg_rating,
        COUNT(*) AS rating_count,
        ROW_NUMBER() OVER (PARTITION BY genre ORDER BY AVG(r.Rating) DESC) AS row_num
    FROM film_ratings r
    JOIN film_movies m ON r.MovieID = m.MovieID
    LATERAL VIEW explode(split(m.Genres, '\\|')) genreTable AS genre
    GROUP BY genre, m.Title, m.MovieID
    HAVING COUNT(*) >= 30
) t
WHERE row_num <= 5
ORDER BY genre, row_num;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM top_movies_by_genre;
```

### 5.6 é«˜çº§åˆ†æ

#### åˆ†æ5ï¼šç”¨æˆ·æ´»è·ƒåº¦åˆ†æ

```sql
-- ç»Ÿè®¡ç”¨æˆ·è¯„åˆ†æ¬¡æ•°åˆ†å¸ƒ
CREATE TABLE IF NOT EXISTS user_activity_analysis AS
SELECT 
    rating_range,
    COUNT(*) AS user_count
FROM (
    SELECT 
        UserID,
        CASE 
            WHEN rating_count <= 20 THEN '1-20'
            WHEN rating_count <= 50 THEN '21-50'
            WHEN rating_count <= 100 THEN '51-100'
            WHEN rating_count <= 200 THEN '101-200'
            ELSE '200+'
        END AS rating_range
    FROM (
        SELECT UserID, COUNT(*) AS rating_count
        FROM film_ratings
        GROUP BY UserID
    ) t1
) t2
GROUP BY rating_range
ORDER BY rating_range;

SELECT * FROM user_activity_analysis;
```

#### åˆ†æ6ï¼šç”µå½±ç±»å‹å—æ¬¢è¿ç¨‹åº¦

```sql
-- ç»Ÿè®¡å„ç±»å‹ç”µå½±çš„å¹³å‡è¯„åˆ†å’Œæ•°é‡
CREATE TABLE IF NOT EXISTS genre_popularity AS
SELECT 
    genre,
    COUNT(DISTINCT m.MovieID) AS movie_count,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS total_ratings
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
LATERAL VIEW explode(split(m.Genres, '\\|')) genreTable AS genre
GROUP BY genre
ORDER BY avg_rating DESC;

SELECT * FROM genre_popularity;
```

------

## ç¬¬å…­éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–

### 6.1 æ•°æ®å­˜å‚¨æ ¼å¼ä¼˜åŒ–

#### ä½¿ç”¨ORCæ ¼å¼æå‡æŸ¥è¯¢æ€§èƒ½

```sql
-- åˆ›å»ºORCæ ¼å¼çš„è¯„åˆ†è¡¨
CREATE TABLE film_ratings_orc(
    UserID INT,
    MovieID INT,
    Rating INT,
    ts BIGINT
)
STORED AS ORC
TBLPROPERTIES (
    'orc.compress'='SNAPPY',
    'orc.create.index'='true'
);

-- ä»åŸè¡¨å¯¼å…¥æ•°æ®
INSERT INTO TABLE film_ratings_orc 
SELECT * FROM film_ratings;

-- æ¯”è¾ƒå­˜å‚¨å¤§å°
-- TextFile: çº¦ 24MB
-- ORC: çº¦ 5MB (å‹ç¼©å)
```

#### ä½¿ç”¨Parquetæ ¼å¼

```sql
-- åˆ›å»ºParquetæ ¼å¼è¡¨
CREATE TABLE film_ratings_parquet(
    UserID INT,
    MovieID INT,
    Rating INT,
    ts BIGINT
)
STORED AS PARQUET;

INSERT INTO TABLE film_ratings_parquet 
SELECT * FROM film_ratings;
```

**å­˜å‚¨æ ¼å¼å¯¹æ¯”ï¼š**

| æ ¼å¼     | å‹ç¼©æ¯” | æŸ¥è¯¢é€Ÿåº¦ | é€‚ç”¨åœºæ™¯           |
| -------- | ------ | -------- | ------------------ |
| TextFile | æ—      | æ…¢       | åŸå§‹æ•°æ®           |
| ORC      | é«˜     | å¿«       | å¤æ‚æŸ¥è¯¢ã€åˆ—å¼è®¿é—® |
| Parquet  | é«˜     | å¿«       | åˆ—å¼å­˜å‚¨ã€è·¨å¹³å°   |
| Avro     | ä¸­     | ä¸­       | æ¨¡å¼æ¼”è¿›           |

### 6.2 åˆ†åŒºä¼˜åŒ–

```sql
-- åˆ›å»ºæŒ‰æ—¥æœŸåˆ†åŒºçš„è¯„åˆ†è¡¨
CREATE TABLE film_ratings_partitioned(
    UserID INT,
    MovieID INT,
    Rating INT,
    ts BIGINT
)
PARTITIONED BY (year STRING, month STRING)
STORED AS ORC;

-- å¼€å¯åŠ¨æ€åˆ†åŒº
SET hive.exec.dynamic.partition=true;
SET hive.exec.dynamic.partition.mode=nonstrict;
SET hive.exec.max.dynamic.partitions=1000;
SET hive.exec.max.dynamic.partitions.pernode=100;

-- æ’å…¥æ•°æ®å¹¶è‡ªåŠ¨åˆ›å»ºåˆ†åŒº
INSERT INTO TABLE film_ratings_partitioned PARTITION(year, month)
SELECT 
    UserID,
    MovieID,
    Rating,
    ts,
    year(from_unixtime(ts)) AS year,
    lpad(month(from_unixtime(ts)), 2, '0') AS month
FROM film_ratings;

-- æŸ¥è¯¢æŒ‡å®šåˆ†åŒºï¼ˆé¿å…å…¨è¡¨æ‰«æï¼‰
SELECT * FROM film_ratings_partitioned
WHERE year='2000' AND month='03'
LIMIT 10;
```

### 6.3 åˆ†æ¡¶ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆ†æ¡¶è¡¨
CREATE TABLE film_ratings_bucketed(
    UserID INT,
    MovieID INT,
    Rating INT,
    ts BIGINT
)
CLUSTERED BY (MovieID) INTO 32 BUCKETS
STORED AS ORC;

-- å¼€å¯åˆ†æ¡¶
SET hive.enforce.bucketing=true;

-- æ’å…¥æ•°æ®
INSERT INTO TABLE film_ratings_bucketed
SELECT * FROM film_ratings;

-- ä½¿ç”¨åˆ†æ¡¶è¡¨è¿›è¡ŒJOINæ“ä½œï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
SELECT /*+ MAPJOIN(m) */
    r.MovieID,
    m.Title,
    COUNT(*) AS rating_count
FROM film_ratings_bucketed r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY r.MovieID, m.Title;
```

### 6.4 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

#### ä½¿ç”¨EXPLAINæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’

```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN 
SELECT m.Title, AVG(r.Rating) AS avg_rating
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY m.Title;

-- æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè®¡åˆ’
EXPLAIN EXTENDED
SELECT m.Title, AVG(r.Rating) AS avg_rating
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY m.Title;
```

#### MapJoinä¼˜åŒ–å°è¡¨å…³è”

```sql
-- è®¾ç½®MapJoiné˜ˆå€¼ï¼ˆ25MBä»¥ä¸‹çš„è¡¨ä¼šè‡ªåŠ¨ä½¿ç”¨MapJoinï¼‰
SET hive.auto.convert.join=true;
SET hive.mapjoin.smalltable.filesize=25000000;

-- æ‰‹åŠ¨æŒ‡å®šMapJoin
SELECT /*+ MAPJOIN(m) */
    r.UserID,
    m.Title,
    r.Rating
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE r.Rating >= 4;
```

#### ä½¿ç”¨CTEç®€åŒ–å¤æ‚æŸ¥è¯¢

```sql
-- ä½¿ç”¨WITHå­å¥ï¼ˆCommon Table Expressionï¼‰
WITH high_rated_movies AS (
    SELECT 
        MovieID,
        AVG(Rating) AS avg_rating,
        COUNT(*) AS rating_count
    FROM film_ratings
    GROUP BY MovieID
    HAVING AVG(Rating) >= 4 AND COUNT(*) >= 50
),
active_users AS (
    SELECT 
        UserID,
        COUNT(*) AS rating_count
    FROM film_ratings
    GROUP BY UserID
    HAVING COUNT(*) >= 100
)
SELECT 
    m.Title,
    h.avg_rating,
    h.rating_count,
    COUNT(DISTINCT r.UserID) AS active_user_count
FROM high_rated_movies h
JOIN film_movies m ON h.MovieID = m.MovieID
JOIN film_ratings r ON h.MovieID = r.MovieID
JOIN active_users a ON r.UserID = a.UserID
GROUP BY m.Title, h.avg_rating, h.rating_count
ORDER BY h.avg_rating DESC
LIMIT 20;
```

### 6.5 å…¶ä»–æ€§èƒ½ä¼˜åŒ–é…ç½®

```sql
-- 1. å¼€å¯æœ¬åœ°æ¨¡å¼ï¼ˆé€‚åˆå°æ•°æ®é‡ï¼‰
SET hive.exec.mode.local.auto=true;
SET hive.exec.mode.local.auto.inputbytes.max=50000000;
SET hive.exec.mode.local.auto.input.files.max=5;

-- 2. å¹¶è¡Œæ‰§è¡Œ
SET hive.exec.parallel=true;
SET hive.exec.parallel.thread.number=8;

-- 3. JVMé‡ç”¨
SET mapreduce.job.jvm.numtasks=10;

-- 4. åˆå¹¶å°æ–‡ä»¶
SET hive.merge.mapfiles=true;
SET hive.merge.mapredfiles=true;
SET hive.merge.size.per.task=256000000;
SET hive.merge.smallfiles.avgsize=16000000;

-- 5. çŸ¢é‡åŒ–æŸ¥è¯¢æ‰§è¡Œ
SET hive.vectorized.execution.enabled=true;
SET hive.vectorized.execution.reduce.enabled=true;

-- 6. å¯ç”¨è°“è¯ä¸‹æ¨
SET hive.optimize.ppd=true;

-- 7. å¯ç”¨åˆ—è£å‰ª
SET hive.optimize.cp=true;
```

------

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 å®‰è£…é…ç½®é—®é¢˜

#### é—®é¢˜1ï¼šHiveæ— æ³•è¿æ¥MySQL

**é”™è¯¯ä¿¡æ¯ï¼š**

```
Exception in thread "main" java.lang.RuntimeException: 
com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: 
Communications link failure
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥MySQLæ˜¯å¦å¯åŠ¨
systemctl status mysqld

# 2. æ£€æŸ¥MySQLè¿œç¨‹è®¿é—®æƒé™
mysql -u root -p
mysql> SELECT host, user FROM mysql.user;
mysql> GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password';
mysql> FLUSH PRIVILEGES;

# 3. æ£€æŸ¥é˜²ç«å¢™
systemctl status firewalld
firewall-cmd --zone=public --add-port=3306/tcp --permanent
firewall-cmd --reload

# 4. éªŒè¯MySQLé©±åŠ¨æ˜¯å¦æ­£ç¡®
ls /usr/local/apache-hive-3.1.3-bin/lib/mysql-connector-java*.jar
```

#### é—®é¢˜2ï¼šGuavaç‰ˆæœ¬å†²çª

**é”™è¯¯ä¿¡æ¯ï¼š**

```
java.lang.NoSuchMethodError: com.google.common.base.Preconditions.checkArgument
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
cd /usr/local/apache-hive-3.1.3-bin/lib
rm -f guava-19.0.jar
cp /usr/local/hadoop-3.3.6/share/hadoop/common/lib/guava-27.0-jre.jar .
```

#### é—®é¢˜3ï¼šæ—¥å¿—å†²çª

**é”™è¯¯ä¿¡æ¯ï¼š**

```
SLF4J: Class path contains multiple SLF4J bindings
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
cd /usr/local/apache-hive-3.1.3-bin/lib
rm -f log4j-slf4j-impl-2.17.1.jar
```

### 7.2 æ•°æ®æ“ä½œé—®é¢˜

#### é—®é¢˜4ï¼šä¸­æ–‡æ•°æ®ä¹±ç 

**è§£å†³æ–¹æ¡ˆï¼š**

```sql
-- åœ¨å»ºè¡¨æ—¶æŒ‡å®šå­—ç¬¦é›†
CREATE TABLE test_chinese(
    id INT,
    name STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
STORED AS TEXTFILE;

-- ç¡®ä¿MySQLä½¿ç”¨UTF-8
ALTER DATABASE hive CHARACTER SET utf8;
# ç¼–è¾‘my.cnf
vim /etc/my.cnf
# æ·»åŠ 
[mysqld]
character-set-server=utf8
collation-server=utf8_general_ci
```

#### é—®é¢˜5ï¼šåˆ†éš”ç¬¦åŒ…å«ç‰¹æ®Šå­—ç¬¦

**æ•°æ®æ–‡ä»¶åŒ…å«`::`åˆ†éš”ç¬¦ï¼š**

```sql
-- ä½¿ç”¨MultiDelimitSerDe
CREATE TABLE test_multi_delim(
    field1 STRING,
    field2 STRING
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::");
```

#### é—®é¢˜6ï¼šæ— æ³•åˆ é™¤æˆ–æ›´æ–°æ•°æ®

**é”™è¯¯ä¿¡æ¯ï¼š**

```
FAILED: SemanticException [Error 10294]: 
Attempt to do update or delete using transaction manager 
that does not support these operations.
```

**è§£å†³æ–¹æ¡ˆï¼š** å‚è€ƒç¬¬å››éƒ¨åˆ†4.4èŠ‚ï¼Œé…ç½®äº‹åŠ¡è¡¨æ”¯æŒã€‚

### 7.3 æ€§èƒ½é—®é¢˜

#### é—®é¢˜7ï¼šæŸ¥è¯¢é€Ÿåº¦æ…¢

**è¯Šæ–­æ­¥éª¤ï¼š**

```sql
-- 1. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN EXTENDED SELECT ...;

-- 2. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†åˆ†åŒº
SHOW PARTITIONS table_name;

-- 3. æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE table_name COMPUTE STATISTICS;
DESCRIBE FORMATTED table_name;
```

**ä¼˜åŒ–å»ºè®®ï¼š**

- ä½¿ç”¨åˆ†åŒºè¡¨å‡å°‘æ•°æ®æ‰«æ
- ä½¿ç”¨ORC/Parquetæ ¼å¼
- å°è¡¨ä½¿ç”¨MapJoin
- åˆç†è®¾ç½®Reduceræ•°é‡

```sql
-- è®¾ç½®Reduceræ•°é‡
SET mapreduce.job.reduces=10;

-- æˆ–æ ¹æ®æ•°æ®é‡è‡ªåŠ¨è®¾ç½®
SET hive.exec.reducers.bytes.per.reducer=256000000;
```

#### é—®é¢˜8ï¼šå†…å­˜æº¢å‡º

**é”™è¯¯ä¿¡æ¯ï¼š**

```
Error: Java heap space
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# ç¼–è¾‘hive-env.sh
vim /usr/local/apache-hive-3.1.3-bin/conf/hive-env.sh

# æ·»åŠ 
export HADOOP_HEAPSIZE=2048
export HADOOP_CLIENT_OPTS="$HADOOP_CLIENT_OPTS -Xmx2048m"
-- åœ¨Hiveä¸­è®¾ç½®
SET mapreduce.map.memory.mb=2048;
SET mapreduce.reduce.memory.mb=4096;
SET mapreduce.map.java.opts=-Xmx1638m;
SET mapreduce.reduce.java.opts=-Xmx3276m;
```

------

## ç¬¬å…«éƒ¨åˆ†ï¼šé«˜çº§ä¸»é¢˜

### 8.1 è‡ªå®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰

#### åˆ›å»ºJava UDF

**ç¼–å†™UDFç±»ï¼š**

```java
package com.example.hive.udf;

import org.apache.hadoop.hive.ql.exec.UDF;
import org.apache.hadoop.io.Text;

public class ToUpperCaseUDF extends UDF {
    public Text evaluate(Text input) {
        if (input == null) {
            return null;
        }
        return new Text(input.toString().toUpperCase());
    }
}
```

**æ‰“åŒ…å¹¶ä¸Šä¼ ï¼š**

```bash
# ç¼–è¯‘æ‰“åŒ…
mvn clean package

# ä¸Šä¼ jaråˆ°HDFS
hdfs dfs -put my-hive-udf.jar /user/hive/lib/
```

**åœ¨Hiveä¸­æ³¨å†Œä½¿ç”¨ï¼š**

```sql
-- æ·»åŠ jaråŒ…
ADD JAR /user/hive/lib/my-hive-udf.jar;

-- åˆ›å»ºä¸´æ—¶å‡½æ•°
CREATE TEMPORARY FUNCTION to_upper 
AS 'com.example.hive.udf.ToUpperCaseUDF';

-- ä½¿ç”¨å‡½æ•°
SELECT to_upper(Title) FROM film_movies LIMIT 10;

-- åˆ›å»ºæ°¸ä¹…å‡½æ•°
CREATE FUNCTION to_upper 
AS 'com.example.hive.udf.ToUpperCaseUDF' 
USING JAR 'hdfs:///user/hive/lib/my-hive-udf.jar';
```

### 8.2 Hiveä¸å…¶ä»–å·¥å…·é›†æˆ

#### ä¸Sparké›†æˆ

```bash
# é…ç½®Sparkä½¿ç”¨Hiveå…ƒæ•°æ®
vim $SPARK_HOME/conf/spark-defaults.conf
# æ·»åŠ 
spark.sql.warehouse.dir=/user/hive/warehouse
spark.sql.catalogImplementation=hive
// Sparkä»£ç è®¿é—®Hiveè¡¨
val spark = SparkSession.builder()
    .appName("Hive Integration")
    .enableHiveSupport()
    .getOrCreate()

// æŸ¥è¯¢Hiveè¡¨
val df = spark.sql("SELECT * FROM film_analysis.film_ratings LIMIT 10")
df.show()
```

#### ä¸HBaseé›†æˆ

```sql
-- åˆ›å»ºHiveå¤–éƒ¨è¡¨å…³è”HBase
CREATE EXTERNAL TABLE hive_hbase_table(
    key STRING,
    value STRING
)
STORED BY 'org.apache.hadoop.hive.hbase.HBaseStorageHandler'
WITH SERDEPROPERTIES (
    "hbase.columns.mapping" = ":key,cf:value"
)
TBLPROPERTIES (
    "hbase.table.name" = "hbase_table"
);
```

### 8.3 æ•°æ®å¯¼å‡º

#### å¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶

```sql
-- å¯¼å‡ºä¸ºCSV
INSERT OVERWRITE LOCAL DIRECTORY '/opt/export/top_movies'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
SELECT * FROM top10_movies_by_ratings;
```

#### å¯¼å‡ºåˆ°HDFS

```sql
-- å¯¼å‡ºåˆ°HDFS
INSERT OVERWRITE DIRECTORY '/user/hive/export/movies'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
SELECT * FROM film_movies;
```

#### ä½¿ç”¨Sqoopå¯¼å‡ºåˆ°MySQL

```bash
# å°†Hiveè¡¨å¯¼å‡ºåˆ°MySQL
sqoop export \
    --connect jdbc:mysql://192.168.128.130:3306/movie_db \
    --username root \
    --password YourPassword@123 \
    --table movies_export \
    --export-dir /user/hive/warehouse/film_analysis.db/film_movies \
    --input-fields-terminated-by '\001'
```

------

## ç¬¬ä¹éƒ¨åˆ†ï¼šå®æˆ˜ç»ƒä¹ é¢˜

### ç»ƒä¹ 1ï¼šåŸºç¡€æŸ¥è¯¢

```sql
-- 1. æŸ¥è¯¢è¯„åˆ†ä¸º5åˆ†çš„æ‰€æœ‰è®°å½•
SELECT * FROM film_ratings WHERE Rating = 5;

-- 2. ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„å¹³å‡è¯„åˆ†
SELECT UserID, AVG(Rating) AS avg_rating
FROM film_ratings
GROUP BY UserID
ORDER BY avg_rating DESC
LIMIT 10;

-- 3. æŸ¥è¯¢è¯„åˆ†æ•°é‡å‰20çš„ç”µå½±
SELECT MovieID, COUNT(*) AS count
FROM film_ratings
GROUP BY MovieID
ORDER BY count DESC
LIMIT 20;
```

### ç»ƒä¹ 2ï¼šå¤šè¡¨å…³è”

```sql
-- 4. æŸ¥è¯¢å¥³æ€§ç”¨æˆ·æœ€å–œæ¬¢çš„ç”µå½±ç±»å‹
SELECT 
    genre,
    COUNT(*) AS rating_count,
    AVG(r.Rating) AS avg_rating
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
LATERAL VIEW explode(split(m.Genres, '\\|')) t AS genre
WHERE u.Gender = 'F'
GROUP BY genre
ORDER BY rating_count DESC;

-- 5. æ‰¾å‡ºè¯„åˆ†å·®å¼‚æœ€å¤§çš„ç”µå½±ï¼ˆç”·å¥³ç”¨æˆ·è¯„åˆ†å·®å¼‚ï¼‰
WITH male_ratings AS (
    SELECT 
        r.MovieID,
        AVG(r.Rating) AS male_avg
    FROM film_ratings r
    JOIN film_users u ON r.UserID = u.UserID
    WHERE u.Gender = 'M'
    GROUP BY r.MovieID
),
female_ratings AS (
    SELECT 
        r.MovieID,
        AVG(r.Rating) AS female_avg
    FROM film_ratings r
    JOIN film_users u ON r.UserID = u.UserID
    WHERE u.Gender = 'F'
    GROUP BY r.MovieID
)
SELECT 
    m.Title,
    ma.male_avg,
    fa.female_avg,
    ABS(ma.male_avg - fa.female_avg) AS rating_diff
FROM male_ratings ma
JOIN female_ratings fa ON ma.MovieID = fa.MovieID
JOIN film_movies m ON ma.MovieID = m.MovieID
ORDER BY rating_diff DESC
LIMIT 20;
```

### ç»ƒä¹ 3ï¼šæ—¶é—´åºåˆ—åˆ†æ

```sql
-- 6. åˆ†æä¸åŒæ—¶é—´æ®µçš„è¯„åˆ†è¶‹åŠ¿
SELECT 
    year(from_unixtime(ts)) AS year,
    month(from_unixtime(ts)) AS month,
    COUNT(*) AS rating_count,
    AVG(Rating) AS avg_rating
FROM film_ratings
GROUP BY year(from_unixtime(ts)), month(from_unixtime(ts))
ORDER BY year, month;

-- 7. æ‰¾å‡ºåœ¨ç‰¹å®šæœˆä»½æœ€å—æ¬¢è¿çš„ç”µå½±
SELECT 
    month(from_unixtime(r.ts)) AS month,
    m.Title,
    COUNT(*) AS rating_count,
    AVG(r.Rating) AS avg_rating
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY month(from_unixtime(r.ts)), m.MovieID, m.Title
ORDER BY month, rating_count DESC;
```

### ç»ƒä¹ 4ï¼šç»¼åˆåˆ†æ

```sql
-- 8. ç”¨æˆ·ç”»åƒåˆ†æï¼šæ‰¾å‡ºä¸åŒèŒä¸šç”¨æˆ·çš„åå¥½ç±»å‹
CREATE TABLE user_genre_preference AS
SELECT 
    u.Occupation,
    genre,
    COUNT(*) AS rating_count,
    AVG(r.Rating) AS avg_rating
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
LATERAL VIEW explode(split(m.Genres, '\\|')) t AS genre
GROUP BY u.Occupation, genre
ORDER BY u.Occupation, rating_count DESC;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM user_genre_preference 
WHERE Occupation = 0 
ORDER BY rating_count DESC 
LIMIT 10;
```

------

## ç¬¬åéƒ¨åˆ†ï¼šé¡¹ç›®æ€»ç»“ä¸æœ€ä½³å®è·µ

### 10.1 Hiveä½¿ç”¨æœ€ä½³å®è·µ

#### 1. è¡¨è®¾è®¡åŸåˆ™

- âœ… **ä¼˜å…ˆä½¿ç”¨åˆ†åŒºè¡¨**ï¼šæŒ‰æ—¥æœŸã€åœ°åŒºç­‰å¸¸ç”¨æŸ¥è¯¢æ¡ä»¶åˆ†åŒº
- âœ… **é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ ¼å¼**ï¼šå¤§æ•°æ®é‡ç”¨ORC/Parquet
- âœ… **åˆç†ä½¿ç”¨åˆ†æ¡¶**ï¼šå¯¹JOINæ“ä½œé¢‘ç¹çš„å­—æ®µåˆ†æ¡¶
- âœ… **å¤–éƒ¨è¡¨ç”¨äºåŸå§‹æ•°æ®**ï¼šä¿æŠ¤æºæ•°æ®ä¸è¢«è¯¯åˆ 

#### 2. æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™

- âœ… **åˆ†åŒºè£å‰ª**ï¼šWHEREæ¡ä»¶ä¸­åŒ…å«åˆ†åŒºå­—æ®µ
- âœ… **åˆ—è£å‰ª**ï¼šåªSELECTéœ€è¦çš„åˆ—
- âœ… **MapJoinå°è¡¨**ï¼šå°è¡¨ï¼ˆ<25MBï¼‰è‡ªåŠ¨ä½¿ç”¨MapJoin
- âœ… **åˆç†ä½¿ç”¨ç¼“å­˜**ï¼šé¢‘ç¹æŸ¥è¯¢çš„ä¸­é—´ç»“æœå­˜ä¸ºè¡¨

#### 3. æ•°æ®ç®¡ç†åŸåˆ™

- âœ… **å®šæœŸæ¸…ç†ä¸´æ—¶è¡¨**
- âœ… **åˆå¹¶å°æ–‡ä»¶**ï¼šé¿å…äº§ç”Ÿå¤§é‡å°æ–‡ä»¶
- âœ… **å‹ç¼©æ•°æ®**ï¼šä½¿ç”¨SNAPPYæˆ–ZLIBå‹ç¼©
- âœ… **æ•°æ®è´¨é‡æ£€æŸ¥**ï¼šå¯¼å…¥åéªŒè¯æ•°æ®å®Œæ•´æ€§

### 10.2 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```sql
-- æ•°æ®åº“æ“ä½œ
SHOW DATABASES;
CREATE DATABASE db_name;
USE db_name;
DROP DATABASE db_name CASCADE;

-- è¡¨æ“ä½œ
SHOW TABLES;
DESCRIBE FORMATTED table_name;
SHOW CREATE TABLE table_name;
SHOW PARTITIONS table_name;
DROP TABLE table_name;

-- æ•°æ®æ“ä½œ
LOAD DATA LOCAL INPATH 'file' INTO TABLE table_name;
INSERT INTO TABLE table_name SELECT ...;
SELECT * FROM table_name LIMIT 10;

-- æ€§èƒ½ä¼˜åŒ–
EXPLAIN SELECT ...;
ANALYZE TABLE table_name COMPUTE STATISTICS;
SET hive.exec.parallel=true;

-- æŸ¥çœ‹é…ç½®
SET -v;  -- æŸ¥çœ‹æ‰€æœ‰é…ç½®
SET property_name;  -- æŸ¥çœ‹ç‰¹å®šé…ç½®
```

### 10.3 å­¦ä¹ è·¯å¾„å»ºè®®

**åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ï¼š**

1. æŒæ¡Hiveå®‰è£…é…ç½®
2. ç†Ÿæ‚‰HQLåŸºæœ¬è¯­æ³•
3. å®Œæˆç®€å•çš„æ•°æ®å¯¼å…¥å’ŒæŸ¥è¯¢

**ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ï¼š**

1. æŒæ¡åˆ†åŒºè¡¨ã€åˆ†æ¡¶è¡¨çš„ä½¿ç”¨
2. å­¦ä¹ JOINã€å­æŸ¥è¯¢ç­‰å¤æ‚æŸ¥è¯¢
3. äº†è§£ä¸åŒå­˜å‚¨æ ¼å¼çš„ç‰¹ç‚¹

**é«˜çº§é˜¶æ®µï¼ˆ1-2æœˆï¼‰ï¼š**

1. æ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜æ’æŸ¥
2. è‡ªå®šä¹‰å‡½æ•°å¼€å‘
3. ä¸å…¶ä»–å¤§æ•°æ®å·¥å…·é›†æˆ

### 10.4 æ¨èèµ„æº

**å®˜æ–¹æ–‡æ¡£ï¼š**

- Apache Hiveå®˜ç½‘ï¼šhttps://hive.apache.org
- Hive Language Manualï¼šhttps://cwiki.apache.org/confluence/display/Hive/LanguageManual

**å­¦ä¹ èµ„æºï¼š**

- Hiveç¼–ç¨‹æŒ‡å—ï¼ˆä¹¦ç±ï¼‰
- Hadoopæƒå¨æŒ‡å—ï¼ˆä¹¦ç±ï¼‰
- å„å¤§æ•°æ®ç¤¾åŒºåšå®¢

------

## é™„å½•ï¼šå®Œæ•´é¡¹ç›®ä»£ç 

### ç”µå½±åˆ†æé¡¹ç›®å®Œæ•´SQLè„šæœ¬

```sql
-- ============================================
-- ç”µå½±ç”¨æˆ·å½±è¯„åˆ†æå®Œæ•´è„šæœ¬
-- ============================================

-- 1. åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS film_analysis
COMMENT 'ç”µå½±ç”¨æˆ·å½±è¯„åˆ†ææ•°æ®åº“';

USE film_analysis;

-- 2. åˆ›å»ºè¡¨
CREATE TABLE IF NOT EXISTS film_ratings(
    UserID INT,
    MovieID INT,
    Rating INT,
    ts BIGINT
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;

CREATE TABLE IF NOT EXISTS film_users(
    UserID INT,
    Gender STRING,
    Age INT,
    Occupation INT,
    Zip_code STRING
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;

CREATE TABLE IF NOT EXISTS film_movies(
    MovieID INT,
    Title STRING,
    Genres STRING
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe'
WITH SERDEPROPERTIES ("field.delim"="::")
STORED AS TEXTFILE;

-- 3. è£…è½½æ•°æ®ï¼ˆå‡è®¾æ•°æ®å·²ä¸Šä¼ åˆ°HDFSï¼‰
LOAD DATA INPATH '/user/film/data/ratings.dat' INTO TABLE film_ratings;
LOAD DATA INPATH '/user/film/data/users.dat' INTO TABLE film_users;
LOAD DATA INPATH '/user/film/data/movies.dat' INTO TABLE film_movies;

-- 4. æ•°æ®éªŒè¯
SELECT COUNT(*) AS ratings_count FROM film_ratings;
SELECT COUNT(*) AS users_count FROM film_users;
SELECT COUNT(*) AS movies_count FROM film_movies;

-- 5. åˆ†æä»»åŠ¡
-- ä»»åŠ¡1ï¼šè¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±
CREATE TABLE top10_movies_by_ratings AS
SELECT 
    r.MovieID,
    m.Title,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_movies m ON r.MovieID = m.MovieID
GROUP BY r.MovieID, m.Title
ORDER BY rating_count DESC
LIMIT 10;

-- ä»»åŠ¡2ï¼šä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±
CREATE TABLE top10_movies_male AS
SELECT 
    m.Title,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE u.Gender = 'M'
GROUP BY m.MovieID, m.Title
HAVING COUNT(*) >= 50
ORDER BY avg_rating DESC
LIMIT 10;

CREATE TABLE top10_movies_female AS
SELECT 
    m.Title,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE u.Gender = 'F'
GROUP BY m.MovieID, m.Title
HAVING COUNT(*) >= 50
ORDER BY avg_rating DESC
LIMIT 10;

-- ä»»åŠ¡3ï¼šæŒ‡å®šç”µå½±å„å¹´é¾„æ®µçš„å¹³å‡è¯„åˆ†
CREATE TABLE movie_ratings_by_age AS
SELECT 
    m.Title,
    u.Age,
    AVG(r.Rating) AS avg_rating,
    COUNT(*) AS rating_count
FROM film_ratings r
JOIN film_users u ON r.UserID = u.UserID
JOIN film_movies m ON r.MovieID = m.MovieID
WHERE r.MovieID = 1
GROUP BY m.Title, u.Age
ORDER BY u.Age;

-- ä»»åŠ¡4ï¼šå„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨
CREATE TABLE top_movies_by_genre AS
SELECT 
    genre,
    Title,
    avg_rating,
    rating_count,
    row_num
FROM (
    SELECT 
        genre,
        m.Title,
        AVG(r.Rating) AS avg_rating,
        COUNT(*) AS rating_count,
        ROW_NUMBER() OVER (PARTITION BY genre ORDER BY AVG(r.Rating) DESC) AS row_num
    FROM film_ratings r
    JOIN film_movies m ON r.MovieID = m.MovieID
    LATERAL VIEW explode(split(m.Genres, '\\|')) genreTable AS genre
    GROUP BY genre, m.Title, m.MovieID
    HAVING COUNT(*) >= 30
) t
WHERE row_num <= 5
ORDER BY genre, row_num;

-- 6. æŸ¥çœ‹ç»“æœ
SELECT * FROM top10_movies_by_ratings;
SELECT * FROM top10_movies_male;
SELECT * FROM top10_movies_female;
SELECT * FROM movie_ratings_by_age;
SELECT * FROM top_movies_by_genre;
```

------

## ç»“è¯­

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å·²ç»å®Œæ•´å­¦ä¹ äº†ï¼š

1. âœ… Hiveçš„åŸºç¡€æ¦‚å¿µå’Œæ¶æ„
2. âœ… Hiveçš„å®‰è£…é…ç½®ï¼ˆå†…åµŒã€ç›´è¿ã€è¿œç¨‹ä¸‰ç§æ¨¡å¼ï¼‰
3. âœ… æ•°æ®åº“å’Œè¡¨çš„åˆ›å»ºä¸ç®¡ç†
4. âœ… æ•°æ®çš„è£…è½½ã€æŸ¥è¯¢ã€æ’å…¥å’Œåˆ é™¤
5. âœ… ç”µå½±ç”¨æˆ·å½±è¯„åˆ†æå®æˆ˜é¡¹ç›®
6. âœ… æ€§èƒ½ä¼˜åŒ–æŠ€å·§
7. âœ… å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

**æ¥ä¸‹æ¥çš„å­¦ä¹ æ–¹å‘ï¼š**

- æ·±å…¥å­¦ä¹ Hiveæ€§èƒ½è°ƒä¼˜
- å­¦ä¹ Hiveä¸Sparkã€Flinkç­‰å·¥å…·çš„é›†æˆ
- æ¢ç´¢å®æ—¶æ•°æ®ä»“åº“æŠ€æœ¯ï¼ˆå¦‚Hudiã€Icebergï¼‰
- å‚ä¸å®é™…çš„å¤§æ•°æ®é¡¹ç›®

**è®°ä½ï¼š** å®è·µæ˜¯æœ€å¥½çš„è€å¸ˆï¼Œå¤šåŠ¨æ‰‹æ“ä½œï¼Œå¤šè§£å†³å®é™…é—®é¢˜ï¼Œä½ ä¼šè¶Šæ¥è¶Šç†Ÿç»ƒï¼

ç¥å­¦ä¹ é¡ºåˆ©ï¼ğŸ‰