# åŸºäºHBaseå®ç°å­˜å‚¨ç”µå½±ç½‘ç«™ç”¨æˆ·å½±è¯„åˆ†æç»“æœ - å®Œæ•´å®æ“æ•™ç¨‹

## ğŸ“š æ•™ç¨‹æ¦‚è¿°

æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨HBaseåˆ†å¸ƒå¼æ•°æ®åº“å­˜å‚¨å’Œç®¡ç†ç”µå½±ç”¨æˆ·å½±è¯„åˆ†æç»“æœã€‚é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å°†å­¦ä¼šHBaseçš„å®‰è£…éƒ¨ç½²ã€Shellå‘½ä»¤æ“ä½œã€Java APIç¼–ç¨‹ï¼Œå¹¶å®Œæˆä¸€ä¸ªå®Œæ•´çš„ç”µå½±æ•°æ®å­˜å‚¨é¡¹ç›®ã€‚

------

## ç¬¬ä¸€éƒ¨åˆ†ï¼šHBaseåŸºç¡€çŸ¥è¯†

### 1.1 ä»€ä¹ˆæ˜¯HBaseï¼Ÿ

**HBaseçš„å®šä¹‰ï¼š**

- HBaseæ˜¯ApacheåŸºäºGoogle BigTableè®ºæ–‡å®ç°çš„å¼€æºåˆ†å¸ƒå¼åˆ—å¼æ•°æ®åº“
- æ„å»ºåœ¨Hadoop HDFSä¹‹ä¸Šï¼Œæä¾›éšæœºã€å®æ—¶è¯»/å†™è®¿é—®èƒ½åŠ›
- é€‚åˆå­˜å‚¨éç»“æ„åŒ–å’ŒåŠç»“æ„åŒ–çš„ç¨€ç–æ•°æ®

**HBaseçš„èµ·æºï¼š**

```
Google BigTable (2006) â†’ HBase (Apacheå¼€æºå®ç°)
```

| å¯¹æ¯”é¡¹   | HBase          | BigTable      |
| -------- | -------------- | ------------- |
| æ–‡ä»¶å­˜å‚¨ | HDFS           | GFS           |
| è®¡ç®—æ¡†æ¶ | Java MapReduce | C++ MapReduce |
| åè°ƒæœåŠ¡ | ZooKeeper      | Chubby        |

### 1.2 HBaseçš„æ ¸å¿ƒç‰¹ç‚¹

#### âœ… 1. æµ·é‡å­˜å‚¨

- æ”¯æŒPBçº§æ•°æ®å­˜å‚¨
- çº¿æ€§æ‰©å±•èƒ½åŠ›
- åˆ†å¸ƒå¼å­˜å‚¨æ¶æ„

#### âœ… 2. é¢å‘åˆ—å­˜å‚¨

- æŒ‰åˆ—æ—ç»„ç»‡æ•°æ®
- åˆ—åŠ¨æ€å¯æ‰©å±•
- é€‚åˆç¨€ç–æ•°æ®

#### âœ… 3. å¤šç‰ˆæœ¬æ”¯æŒ

- æ¯ä¸ªå•å…ƒæ ¼å¯ä¿å­˜å¤šä¸ªç‰ˆæœ¬
- åŸºäºæ—¶é—´æˆ³ç®¡ç†ç‰ˆæœ¬
- æ”¯æŒå†å²æ•°æ®è¿½æº¯

#### âœ… 4. é«˜å¯é æ€§

- æ•°æ®è‡ªåŠ¨å¤åˆ¶
- RegionServeræ•…éšœè‡ªåŠ¨æ¢å¤
- æ”¯æŒæ•°æ®å¤‡ä»½

#### âœ… 5. é«˜æ€§èƒ½

- æ¯«ç§’çº§å“åº”
- æ”¯æŒç™¾ä¸‡çº§QPS
- å†…å­˜+ç£ç›˜æ··åˆå­˜å‚¨

### 1.3 HBase vs ä¼ ç»Ÿæ•°æ®åº“

| å¯¹æ¯”ç»´åº¦     | HBase                  | ä¼ ç»Ÿå…³ç³»æ•°æ®åº“   |
| ------------ | ---------------------- | ---------------- |
| **æ•°æ®ç±»å‹** | å­—èŠ‚æ•°ç»„ï¼Œæ— ç±»å‹é™åˆ¶   | ä¸¥æ ¼çš„æ•°æ®ç±»å‹   |
| **æ•°æ®æ“ä½œ** | å¢åˆ æŸ¥ï¼Œä¸æ”¯æŒå¤æ‚äº‹åŠ¡ | æ”¯æŒå®Œæ•´ACIDäº‹åŠ¡ |
| **å­˜å‚¨æ¨¡å¼** | åˆ—å¼å­˜å‚¨ï¼Œç¨€ç–         | è¡Œå¼å­˜å‚¨ï¼Œå¯†é›†   |
| **æ•°æ®ç´¢å¼•** | åªæ”¯æŒRowKeyç´¢å¼•       | æ”¯æŒå¤šç§ç´¢å¼•     |
| **æ‰©å±•æ€§**   | æ°´å¹³æ‰©å±•ï¼Œçº¿æ€§å¢é•¿     | å‚ç›´æ‰©å±•ï¼Œæœ‰é™   |
| **æŸ¥è¯¢è¯­è¨€** | æ— SQLï¼Œä½¿ç”¨API         | æ ‡å‡†SQL          |
| **é€‚ç”¨åœºæ™¯** | å¤§æ•°æ®å®æ—¶è¯»å†™         | ç»“æ„åŒ–æ•°æ®ç®¡ç†   |

### 1.4 HBaseç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Client å®¢æˆ·ç«¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚
             â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ZooKeeper    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  HMasterä¸»èŠ‚ç‚¹  â”‚
    â”‚   åè°ƒæœåŠ¡      â”‚        â”‚  (Active/Backup)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚
             â”‚                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         RegionServeré›†ç¾¤ (æ•°æ®èŠ‚ç‚¹)          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ RegionServer1â”‚ RegionServer2â”‚ RegionServer3 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Region  â”‚ â”‚  â”‚ Region  â”‚ â”‚  â”‚ Region  â”‚ â”‚
    â”‚  â”‚ Region  â”‚ â”‚  â”‚ Region  â”‚ â”‚  â”‚ Region  â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  HDFS å­˜å‚¨å±‚   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶è¯´æ˜ï¼š**

1. **Clientï¼ˆå®¢æˆ·ç«¯ï¼‰**
   - æä¾›è®¿é—®HBaseçš„æ¥å£
   - ç»´æŠ¤ç¼“å­˜åŠ é€Ÿè®¿é—®
   - é€šè¿‡ZooKeeperå®šä½æ•°æ®
2. **ZooKeeperï¼ˆåè°ƒæœåŠ¡ï¼‰**
   - å­˜å‚¨-ROOT-è¡¨ä½ç½®
   - ç›‘æ§RegionServerçŠ¶æ€
   - ç®¡ç†HMasteré€‰ä¸¾
   - ç»´æŠ¤é›†ç¾¤é…ç½®
3. **HMasterï¼ˆä¸»èŠ‚ç‚¹ï¼‰**
   - ç®¡ç†RegionServer
   - è´Ÿè´£Regionåˆ†é…å’Œè´Ÿè½½å‡è¡¡
   - å¤„ç†DDLæ“ä½œï¼ˆåˆ›å»º/åˆ é™¤è¡¨ï¼‰
   - ç›‘æ§é›†ç¾¤çŠ¶æ€
4. **RegionServerï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰**
   - ç®¡ç†å¤šä¸ªRegion
   - å¤„ç†è¯»å†™è¯·æ±‚
   - æ‰§è¡ŒRegionåˆ†è£‚å’Œåˆå¹¶
   - ç»´æŠ¤HLogå’ŒMemStore
5. **HDFSï¼ˆå­˜å‚¨å±‚ï¼‰**
   - æŒä¹…åŒ–å­˜å‚¨æ•°æ®
   - æä¾›æ•°æ®å†—ä½™
   - ä¿è¯æ•°æ®å¯é æ€§

### 1.5 HBaseæ•°æ®æ¨¡å‹

#### æ•°æ®æ¨¡å‹ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HBase Table                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Row Key   â”‚Timestamp â”‚      Column Family                     â”‚
â”‚   (è¡Œé”®)    â”‚  (æ—¶é—´æˆ³) â”‚      (åˆ—æ—)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚          â”‚   cf1       â”‚         cf2              â”‚
â”‚            â”‚          â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚          â”‚ col1 â”‚ col2 â”‚  col1  â”‚  col2  â”‚  col3  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   row1     â”‚   t3     â”‚ v1   â”‚  v2  â”‚   v3   â”‚   v4   â”‚   v5   â”‚
â”‚   row2     â”‚   t2     â”‚ v6   â”‚  v7  â”‚   v8   â”‚   v9   â”‚   v10  â”‚
â”‚   row3     â”‚   t1     â”‚ v11  â”‚  v12 â”‚   v13  â”‚   v14  â”‚   v15  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

**1. Row Keyï¼ˆè¡Œé”®ï¼‰**

```java
// ç‰¹ç‚¹ï¼š
- å”¯ä¸€æ ‡è¯†ä¸€è¡Œæ•°æ®ï¼ˆç±»ä¼¼ä¸»é”®ï¼‰
- æŒ‰å­—å…¸åºæ’åºå­˜å‚¨
- æŸ¥è¯¢çš„å”¯ä¸€ç´¢å¼•
- è®¾è®¡åŸåˆ™ï¼šæ•£åˆ—ã€å®šé•¿ã€å¯è¯»

// ç¤ºä¾‹ï¼š
"user_20241101_001"     // ç”¨æˆ·ID + æ—¥æœŸ + åºå·
"movie_1234_rating"     // ç”µå½±ID + ç±»å‹
"2024#device001#log"    // æ—¶é—´ + è®¾å¤‡ + ç±»å‹
```

**2. Column Familyï¼ˆåˆ—æ—ï¼‰**

```java
// ç‰¹ç‚¹ï¼š
- å»ºè¡¨æ—¶å¿…é¡»å®šä¹‰
- ç‰©ç†å­˜å‚¨å•å…ƒ
- åŒä¸€åˆ—æ—æ•°æ®å­˜å‚¨åœ¨ä¸€èµ·
- æ•°é‡å»ºè®®ï¼š1-3ä¸ª

// ç¤ºä¾‹è¡¨ç»“æ„ï¼š
CREATE TABLE 'user_info' {
    NAME => 'basic',     // åŸºæœ¬ä¿¡æ¯åˆ—æ—
    NAME => 'contact',   // è”ç³»æ–¹å¼åˆ—æ—
    NAME => 'address'    // åœ°å€ä¿¡æ¯åˆ—æ—
}
```

**3. Column Qualifierï¼ˆåˆ—é™å®šç¬¦ï¼‰**

```java
// ç‰¹ç‚¹ï¼š
- åˆ—æ—ä¸‹çš„å…·ä½“åˆ—
- æ— éœ€é¢„å…ˆå®šä¹‰
- åŠ¨æ€æ·»åŠ 
- æ ¼å¼ï¼šåˆ—æ—:åˆ—é™å®šç¬¦

// ç¤ºä¾‹ï¼š
basic:name       // åŸºæœ¬ä¿¡æ¯:å§“å
basic:age        // åŸºæœ¬ä¿¡æ¯:å¹´é¾„
contact:phone    // è”ç³»æ–¹å¼:ç”µè¯
contact:email    // è”ç³»æ–¹å¼:é‚®ç®±
```

**4. Timestampï¼ˆæ—¶é—´æˆ³ï¼‰**

```java
// ç‰¹ç‚¹ï¼š
- æ¯ä¸ªå•å…ƒæ ¼çš„ç‰ˆæœ¬æ ‡è¯†
- é»˜è®¤ä¸ºå†™å…¥æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- æ”¯æŒå¤šç‰ˆæœ¬æ•°æ®
- å¯è‡ªå®šä¹‰æ—¶é—´æˆ³

// æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬ï¼š
get 'table', 'row1', {COLUMN => 'cf:col', TIMESTAMP => 1234567890}

// æŸ¥è¯¢æ‰€æœ‰ç‰ˆæœ¬ï¼š
get 'table', 'row1', {COLUMN => 'cf:col', VERSIONS => 5}
```

**5. Cellï¼ˆå•å…ƒæ ¼ï¼‰**

```java
// å®Œæ•´å®šä½ï¼š
{RowKey, ColumnFamily, Column, Timestamp} â†’ Value

// ç¤ºä¾‹ï¼š
{
    "user001",           // Row Key
    "basic:name",        // Column Family:Column
    1234567890,          // Timestamp
    "å¼ ä¸‰"                // Value
}
```

#### æ•°æ®æ¨¡å‹ç¤ºä¾‹

**ç”¨æˆ·ä¿¡æ¯è¡¨è®¾è®¡ï¼š**

```
Table: user_profile
RowKey: user_id

Row Key    | Timestamp |  basic:name  | basic:age | contact:phone | contact:email
-----------|-----------|--------------|-----------|---------------|---------------
user_001   | t3        | å¼ ä¸‰          | 25        | 138xxx        | zhang@xx.com
           | t2        | å¼ ä¸‰          | 24        | 138xxx        | zhang@xx.com
           | t1        | å¼ å°ä¸‰        | 24        | 138xxx        | zhang@xx.com
user_002   | t2        | æå››          | 30        | 139xxx        | li@xx.com
user_003   | t1        | ç‹äº”          | 28        | 137xxx        | wang@xx.com
```

### 1.6 HBaseè¯»å†™æµç¨‹

#### å†™æµç¨‹è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. è¯·æ±‚å†™å…¥æ•°æ®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ZooKeeper   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. è¿”å›.meta.è¡¨ä½ç½®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .meta. Region   â”‚
â”‚ Server          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. è¿”å›ç›®æ ‡Regionä½ç½®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Target RegionServer           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. å†™å…¥HLog (WAL)       â”‚   â”‚ 4. å†™å…¥æ•°æ®
â”‚  â”‚     â†“                    â”‚   â”‚
â”‚  â”‚  2. å†™å…¥MemStore(å†…å­˜)   â”‚   â”‚
â”‚  â”‚     â†“                    â”‚   â”‚
â”‚  â”‚  3. MemStoreæ»¡â†’åˆ·å†™      â”‚   â”‚
â”‚  â”‚     â†“                    â”‚   â”‚
â”‚  â”‚  4. ç”ŸæˆHFileå­˜å‚¨åˆ°HDFS  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. è¿”å›å†™å…¥æˆåŠŸ
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†™æµç¨‹æ­¥éª¤ï¼š**

1. **å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚**

   - Clientå‘ZooKeeperæŸ¥è¯¢.meta.è¡¨ä½ç½®
   - è·å–ç›®æ ‡æ•°æ®çš„Regionä¿¡æ¯

2. **å®šä½ç›®æ ‡Region**

   - é€šè¿‡.meta.è¡¨æ‰¾åˆ°ç›®æ ‡RegionServer
   - ç¼“å­˜Regionä½ç½®ä¿¡æ¯

3. **å†™å…¥æ•°æ®**

   ```
   a. å…ˆå†™HLogï¼ˆé¢„å†™æ—¥å¿—ï¼‰
      - ä¿è¯æ•°æ®æŒä¹…æ€§
      - ç”¨äºæ•…éšœæ¢å¤
   
   b. å†™å…¥MemStoreï¼ˆå†…å­˜ï¼‰
      - å†…å­˜ä¸­çš„æ’åºç¼“å†²åŒº
      - æä¾›å¿«é€Ÿå†™å…¥
   
   c. è¿”å›å®¢æˆ·ç«¯æˆåŠŸ
      - å¼‚æ­¥åˆ·å†™åˆ°ç£ç›˜
   ```

4. **åˆ·å†™æœºåˆ¶**

   ```
   è§¦å‘æ¡ä»¶ï¼š
   - MemStoreè¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤128MBï¼‰
   - Regionä¸­æ‰€æœ‰MemStoreè¾¾åˆ°ä¸Šé™
   - å®šæœŸåˆ·å†™ï¼ˆé»˜è®¤1å°æ—¶ï¼‰
   - æ‰‹åŠ¨flushå‘½ä»¤
   
   åˆ·å†™è¿‡ç¨‹ï¼š
   MemStore â†’ HFile â†’ HDFS
   ```

#### è¯»æµç¨‹è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. è¯·æ±‚è¯»å–æ•°æ®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ZooKeeper   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. è¿”å›.meta.è¡¨ä½ç½®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .meta. Region   â”‚
â”‚ Server          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. è¿”å›ç›®æ ‡Regionä½ç½®
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Target RegionServer                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¯»å–é¡ºåºï¼š                    â”‚   â”‚ 4. è¯»å–æ•°æ®
â”‚  â”‚  1. BlockCache (è¯»ç¼“å­˜)       â”‚   â”‚
â”‚  â”‚  2. MemStore (å†…å­˜)           â”‚   â”‚
â”‚  â”‚  3. HFile (ç£ç›˜)              â”‚   â”‚
â”‚  â”‚                               â”‚   â”‚
â”‚  â”‚  åˆå¹¶ç»“æœ â†’ è¿”å›æœ€æ–°ç‰ˆæœ¬      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. è¿”å›æŸ¥è¯¢ç»“æœ
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯»æµç¨‹æ­¥éª¤ï¼š**

1. **å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚**

   - å‘ZooKeeperæŸ¥è¯¢.meta.è¡¨
   - è·å–ç›®æ ‡Regionä½ç½®

2. **å®šä½æ•°æ®ä½ç½®**

   - é€šè¿‡.meta.è¡¨æ‰¾åˆ°RegionServer
   - ç¼“å­˜ä½ç½®ä¿¡æ¯

3. **å¤šå±‚æŸ¥è¯¢**

   ```
   a. BlockCacheï¼ˆè¯»ç¼“å­˜ï¼‰
      - LRUç¼“å­˜æœ€è¿‘è¯»å–çš„Block
      - å‘½ä¸­åˆ™ç›´æ¥è¿”å›
   
   b. MemStoreï¼ˆå†…å­˜å­˜å‚¨ï¼‰
      - æŸ¥è¯¢æœªåˆ·å†™çš„æ–°æ•°æ®
      - åˆå¹¶åˆ°ç»“æœä¸­
   
   c. HFileï¼ˆç£ç›˜æ–‡ä»¶ï¼‰
      - é€šè¿‡Bloom Filterè¿‡æ»¤
      - æŸ¥è¯¢ç£ç›˜æ•°æ®
      - åŠ è½½åˆ°BlockCache
   ```

4. **åˆå¹¶è¿”å›**

   - åˆå¹¶å¤šä¸ªæ¥æºçš„æ•°æ®
   - æŒ‰æ—¶é—´æˆ³è¿”å›æœ€æ–°ç‰ˆæœ¬
   - ç¼“å­˜æŸ¥è¯¢ç»“æœ

### 1.7 .meta.è¡¨è¯¦è§£

**.meta.è¡¨ç»“æ„ï¼š**

```
RowKey: TableName,StartKey,Timestamp

Columns:
â”œâ”€â”€ info:regioninfo    // Regionè¯¦ç»†ä¿¡æ¯
â”‚   â””â”€â”€ StartKey, EndKey, Familyåˆ—è¡¨
â”œâ”€â”€ info:server        // RegionServeråœ°å€
â”‚   â””â”€â”€ hostname:port
â””â”€â”€ info:serverstartcode // RegionServerå¯åŠ¨æ—¶é—´
```

**ç¤ºä¾‹ï¼š**

```
RowKey: film_ratings,,1234567890
â”œâ”€â”€ info:regioninfo â†’ {StartKey='', EndKey='movie_1000', families=['cf']}
â”œâ”€â”€ info:server â†’ slave1:16020
â””â”€â”€ info:serverstartcode â†’ 1234567890000
```

------

## ç¬¬äºŒéƒ¨åˆ†ï¼šZooKeeperå®‰è£…é…ç½®

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ZooKeeperï¼Ÿ

**ZooKeeperåœ¨HBaseä¸­çš„ä½œç”¨ï¼š**

1. **Masteré€‰ä¸¾**
   - ä¿è¯å”¯ä¸€æ´»è·ƒMaster
   - Masteræ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾
   - é¿å…è„‘è£‚é—®é¢˜
2. **RegionServerç›‘æ§**
   - å®æ—¶ç›‘æ§RegionServerçŠ¶æ€
   - èŠ‚ç‚¹æ•…éšœåŠæ—¶å‘ç°
   - è§¦å‘æ•…éšœè½¬ç§»
3. **å…ƒæ•°æ®å­˜å‚¨**
   - å­˜å‚¨-ROOT-è¡¨ä½ç½®
   - ç»´æŠ¤é›†ç¾¤é…ç½®
   - ç®¡ç†Regionåˆ†é…ä¿¡æ¯
4. **åˆ†å¸ƒå¼åè°ƒ**
   - æä¾›åˆ†å¸ƒå¼é”
   - å®ç°é…ç½®åŒæ­¥
   - ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 2.2 ZooKeeperé›†ç¾¤è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ZooKeeper Cluster              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚  Leader  â”‚â—„â”€â”€â–ºâ”‚ Follower â”‚        â”‚
â”‚   â”‚  (é¢†å¯¼è€…) â”‚    â”‚  (è·Ÿéšè€…) â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚               â”‚              â”‚
â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”‚
â”‚        â””â”€â”€â”€â–ºâ”‚   Follower    â”‚         â”‚
â”‚             â”‚   (è·Ÿéšè€…)     â”‚         â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                  â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚             â”‚   Observer    â”‚         â”‚
â”‚             â”‚   (è§‚å¯Ÿè€…)     â”‚         â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| è§’è‰²         | èŒè´£                   | ç‰¹ç‚¹                     |
| ------------ | ---------------------- | ------------------------ |
| **Leader**   | å¤„ç†å†™è¯·æ±‚ã€å‘èµ·æŠ•ç¥¨   | å”¯ä¸€ï¼Œé€šè¿‡é€‰ä¸¾äº§ç”Ÿ       |
| **Follower** | å¤„ç†è¯»è¯·æ±‚ã€å‚ä¸æŠ•ç¥¨   | å¤šä¸ªï¼Œå‚ä¸é€‰ä¸¾           |
| **Observer** | å¤„ç†è¯»è¯·æ±‚ã€ä¸å‚ä¸æŠ•ç¥¨ | æ‰©å±•è¯»èƒ½åŠ›ï¼Œä¸å½±å“å†™æ€§èƒ½ |

### 2.3 ZooKeeperé€‰ä¸¾æœºåˆ¶

**é€‰ä¸¾æ¶‰åŠçš„æ¦‚å¿µï¼š**

1. **æœåŠ¡å™¨IDï¼ˆmyidï¼‰**
   - æ¯ä¸ªèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
   - é…ç½®åœ¨dataDir/myidæ–‡ä»¶ä¸­
   - IDè¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
2. **é€‰ä¸¾çŠ¶æ€**
   - LOOKINGï¼šé€‰ä¸¾çŠ¶æ€
   - FOLLOWINGï¼šè·Ÿéšè€…çŠ¶æ€
   - LEADINGï¼šé¢†å¯¼è€…çŠ¶æ€
   - OBSERVINGï¼šè§‚å¯Ÿè€…çŠ¶æ€
3. **æ•°æ®IDï¼ˆZXIDï¼‰**
   - äº‹åŠ¡IDï¼Œ64ä½æ•°å­—
   - é«˜32ä½ï¼šepochï¼ˆé€‰ä¸¾è½®æ¬¡ï¼‰
   - ä½32ä½ï¼šé€’å¢è®¡æ•°å™¨
   - ZXIDè¶Šå¤§æ•°æ®è¶Šæ–°
4. **é€»è¾‘æ—¶é’Ÿï¼ˆEpochï¼‰**
   - æŠ•ç¥¨è½®æ¬¡
   - æ¯æ¬¡é€‰ä¸¾é€’å¢
   - ç”¨äºåŒºåˆ†ä¸åŒè½®æ¬¡çš„æŠ•ç¥¨

**é€‰ä¸¾è¿‡ç¨‹ç¤ºä¾‹ï¼š**

```
åˆå§‹çŠ¶æ€ï¼š3ä¸ªèŠ‚ç‚¹å¯åŠ¨
myid: server1=1, server2=2, server3=3

ç¬¬1è½®æŠ•ç¥¨ï¼š
server1: æŠ•ç¥¨ç»™è‡ªå·± (1, ZXID1)
server2: æŠ•ç¥¨ç»™è‡ªå·± (2, ZXID2)  
server3: æŠ•ç¥¨ç»™è‡ªå·± (3, ZXID3)

æ¯”è¾ƒè§„åˆ™ï¼š
1. å…ˆæ¯”è¾ƒZXIDï¼Œå¤§çš„èƒœå‡º
2. ZXIDç›¸åŒï¼Œæ¯”è¾ƒmyidï¼Œå¤§çš„èƒœå‡º

ç¬¬2è½®æŠ•ç¥¨ï¼ˆå‡è®¾ZXIDç›¸åŒï¼‰ï¼š
server1: æ”¹æŠ•server3 (å› ä¸º3 > 1)
server2: æ”¹æŠ•server3 (å› ä¸º3 > 2)
server3: ä»æŠ•è‡ªå·±

æœ€ç»ˆç»“æœï¼š
server3è·å¾—3ç¥¨ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰ > åŠæ•°(2)
server3æˆä¸ºLeader
server1ã€server2æˆä¸ºFollower
```

### 2.4 ZooKeeperå®‰è£…éƒ¨ç½²ï¼ˆå®æ“ï¼‰

#### ç¯å¢ƒå‡†å¤‡

**é›†ç¾¤è§„åˆ’ï¼š**

```
èŠ‚ç‚¹      IP              è§’è‰²          myid
slave1    192.168.128.131  Follower     1
slave2    192.168.128.132  Follower     2
slave3    192.168.128.133  Follower     3
```

#### Step 1: ä¸‹è½½å¹¶ä¸Šä¼ ZooKeeper

```bash
# ä¸‹è½½ZooKeeper 3.5.7ï¼ˆæ¨èç¨³å®šç‰ˆæœ¬ï¼‰
# å®˜ç½‘ï¼šhttps://zookeeper.apache.org/releases.html

# ä¸Šä¼ åˆ°slave1çš„/opt/appsç›®å½•
# ä½¿ç”¨Xftpæˆ–scpå‘½ä»¤
```

#### Step 2: è§£å‹å®‰è£…åŒ…

```bash
# åœ¨slave1èŠ‚ç‚¹æ“ä½œ
cd /opt/apps

# è§£å‹åˆ°/usr/localç›®å½•
tar -zxvf apache-zookeeper-3.5.7-bin.tar.gz -C /usr/local/

# é‡å‘½åï¼ˆå¯é€‰ï¼‰
cd /usr/local
mv apache-zookeeper-3.5.7-bin zookeeper-3.5.7

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /usr/local/zookeeper-3.5.7/data
mkdir -p /usr/local/zookeeper-3.5.7/logs
```

#### Step 3: é…ç½®zoo.cfg

```bash
cd /usr/local/zookeeper-3.5.7/conf

# å¤åˆ¶é…ç½®æ¨¡æ¿
cp zoo_sample.cfg zoo.cfg

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim zoo.cfg
```

**zoo.cfgé…ç½®å†…å®¹ï¼š**

```properties
# åŸºæœ¬é…ç½®
# å¿ƒè·³æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
tickTime=2000

# Followeråˆå§‹åŒ–è¿æ¥Leaderçš„è¶…æ—¶æ—¶é—´ï¼ˆtickTimeçš„å€æ•°ï¼‰
initLimit=10

# Followerä¸LeaderåŒæ­¥çš„è¶…æ—¶æ—¶é—´ï¼ˆtickTimeçš„å€æ•°ï¼‰
syncLimit=5

# æ•°æ®ç›®å½•
dataDir=/usr/local/zookeeper-3.5.7/data

# æ—¥å¿—ç›®å½•
dataLogDir=/usr/local/zookeeper-3.5.7/logs

# å®¢æˆ·ç«¯è¿æ¥ç«¯å£
clientPort=2181

# å•ä¸ªå®¢æˆ·ç«¯æœ€å¤§è¿æ¥æ•°
maxClientCnxns=60

# è‡ªåŠ¨æ¸…ç†å¿«ç…§å’Œæ—¥å¿—
autopurge.snapRetainCount=3
autopurge.purgeInterval=1

# é›†ç¾¤é…ç½®ï¼ˆæ ¼å¼ï¼šserver.myid=host:é€šä¿¡ç«¯å£:é€‰ä¸¾ç«¯å£ï¼‰
server.1=slave1:2888:3888
server.2=slave2:2888:3888
server.3=slave3:2888:3888
```

**é…ç½®è¯´æ˜ï¼š**

```
server.X=hostname:port1:port2
â”œâ”€â”€ X: myidå€¼
â”œâ”€â”€ hostname: æœåŠ¡å™¨ä¸»æœºåæˆ–IP
â”œâ”€â”€ port1(2888): Followerä¸Leaderé€šä¿¡ç«¯å£
â””â”€â”€ port2(3888): Leaderé€‰ä¸¾ç«¯å£
```

#### Step 4: åˆ›å»ºmyidæ–‡ä»¶

```bash
# åœ¨slave1èŠ‚ç‚¹åˆ›å»ºmyid
echo "1" > /usr/local/zookeeper-3.5.7/data/myid

# éªŒè¯
cat /usr/local/zookeeper-3.5.7/data/myid
# è¾“å‡ºï¼š1
```

#### Step 5: é…ç½®ç¯å¢ƒå˜é‡

```bash
# ç¼–è¾‘profile
vim /etc/profile

# æ·»åŠ ä»¥ä¸‹å†…å®¹
export ZOOKEEPER_HOME=/usr/local/zookeeper-3.5.7
export PATH=$PATH:$ZOOKEEPER_HOME/bin

# ä½¿é…ç½®ç”Ÿæ•ˆ
source /etc/profile

# éªŒè¯
zkServer.sh --help
```

#### Step 6: åˆ†å‘åˆ°å…¶ä»–èŠ‚ç‚¹

```bash
# å°†ZooKeeperç›®å½•åˆ†å‘åˆ°slave2å’Œslave3
scp -r /usr/local/zookeeper-3.5.7 root@slave2:/usr/local/
scp -r /usr/local/zookeeper-3.5.7 root@slave3:/usr/local/

# åˆ†å‘ç¯å¢ƒå˜é‡é…ç½®
scp /etc/profile root@slave2:/etc/
scp /etc/profile root@slave3:/etc/

# åœ¨slave2èŠ‚ç‚¹ä¿®æ”¹myid
ssh root@slave2 "echo '2' > /usr/local/zookeeper-3.5.7/data/myid"

# åœ¨slave3èŠ‚ç‚¹ä¿®æ”¹myid
ssh root@slave3 "echo '3' > /usr/local/zookeeper-3.5.7/data/myid"

# åœ¨slave2å’Œslave3èŠ‚ç‚¹åˆ·æ–°ç¯å¢ƒå˜é‡
ssh root@slave2 "source /etc/profile"
ssh root@slave3 "source /etc/profile"
```

#### Step 7: å¯åŠ¨ZooKeeperé›†ç¾¤

```bash
# åœ¨slave1èŠ‚ç‚¹å¯åŠ¨
zkServer.sh start

# åœ¨slave2èŠ‚ç‚¹å¯åŠ¨
ssh root@slave2 "zkServer.sh start"

# åœ¨slave3èŠ‚ç‚¹å¯åŠ¨
ssh root@slave3 "zkServer.sh start"
```

**å¯åŠ¨æˆåŠŸè¾“å‡ºï¼š**

```
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper-3.5.7/bin/../conf/zoo.cfg
Starting zookeeper ... STARTED
```

#### Step 8: æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```bash
# åœ¨slave1èŠ‚ç‚¹æŸ¥çœ‹çŠ¶æ€
zkServer.sh status

# è¾“å‡ºç¤ºä¾‹ï¼ˆFollowerï¼‰ï¼š
ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper-3.5.7/bin/../conf/zoo.cfg
Client port found: 2181. Client address: localhost.
Mode: follower

# åœ¨slave2èŠ‚ç‚¹æŸ¥çœ‹
ssh root@slave2 "zkServer.sh status"
# å¯èƒ½è¾“å‡ºï¼šMode: leader

# åœ¨slave3èŠ‚ç‚¹æŸ¥çœ‹
ssh root@slave3 "zkServer.sh status"
# å¯èƒ½è¾“å‡ºï¼šMode: follower
```

**éªŒè¯é›†ç¾¤ï¼š**

```bash
# ä½¿ç”¨zkCliè¿æ¥
zkCli.sh -server slave1:2181

# æˆåŠŸè¿æ¥åï¼Œåœ¨æç¤ºç¬¦ä¸‹æ‰§è¡Œï¼š
[zk: slave1:2181(CONNECTED) 0] ls /
# è¾“å‡ºï¼š[zookeeper]

# åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹
[zk: slave1:2181(CONNECTED) 1] create /test "hello"
# è¾“å‡ºï¼šCreated /test

# åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹éªŒè¯
[zk: slave2:2181(CONNECTED) 0] get /test
# è¾“å‡ºï¼šhello

# é€€å‡º
quit
```

#### Step 9: åœæ­¢ZooKeeperæœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰èŠ‚ç‚¹çš„ZooKeeper
zkServer.sh stop
ssh root@slave2 "zkServer.sh stop"
ssh root@slave3 "zkServer.sh stop"
```

### 2.5 ZooKeeperå¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
zkServer.sh start

# åœæ­¢æœåŠ¡
zkServer.sh stop

# é‡å¯æœåŠ¡
zkServer.sh restart

# æŸ¥çœ‹çŠ¶æ€
zkServer.sh status

# è¿æ¥å®¢æˆ·ç«¯
zkCli.sh -server localhost:2181

# å®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤
ls /                    # åˆ—å‡ºèŠ‚ç‚¹
create /node "data"     # åˆ›å»ºèŠ‚ç‚¹
get /node              # è·å–èŠ‚ç‚¹æ•°æ®
set /node "newdata"    # è®¾ç½®èŠ‚ç‚¹æ•°æ®
delete /node           # åˆ é™¤èŠ‚ç‚¹
quit                   # é€€å‡ºå®¢æˆ·ç«¯
```

------

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šHBaseé›†ç¾¤å®‰è£…éƒ¨ç½²

### 3.1 HBaseé›†ç¾¤è§„åˆ’

```
èŠ‚ç‚¹      IP              è§’è‰²
master    192.168.128.130  HMaster
slave1    192.168.128.131  RegionServer + ZooKeeper
slave2    192.168.128.132  RegionServer + ZooKeeper
slave3    192.168.128.133  RegionServer + ZooKeeper
```

### 3.2 HBaseå®‰è£…æ­¥éª¤ï¼ˆå®æ“ï¼‰

#### Step 1: ä¸‹è½½å¹¶ä¸Šä¼ HBase

```bash
# ä¸‹è½½HBase 2.2.7ï¼ˆä¸Hadoop 3.xå…¼å®¹ï¼‰
# å®˜ç½‘ï¼šhttps://hbase.apache.org/downloads.html

# ä¸Šä¼ åˆ°masterèŠ‚ç‚¹çš„/opt/appsç›®å½•
```

#### Step 2: è§£å‹å®‰è£…åŒ…

```bash
# åœ¨masterèŠ‚ç‚¹æ“ä½œ
cd /opt/apps

# è§£å‹
tar -zxvf hbase-2.2.7-bin.tar.gz -C /usr/local/

# è¿›å…¥ç›®å½•
cd /usr/local/hbase-2.2.7
```

#### Step 3: é…ç½®hbase-env.sh

```bash
cd /usr/local/hbase-2.2.7/conf
vim hbase-env.sh
```

**æ·»åŠ /ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š**

```bash
# Javaç¯å¢ƒ
export JAVA_HOME=/usr/local/jdk1.8.0_333

# ä¸ä½¿ç”¨HBaseè‡ªå¸¦çš„ZooKeeper
export HBASE_MANAGES_ZK=false

# HBaseè¿›ç¨‹PIDç›®å½•
export HBASE_PID_DIR=/usr/local/hbase-2.2.7/pids

# HBaseæ—¥å¿—ç›®å½•
export HBASE_LOG_DIR=/usr/local/hbase-2.2.7/logs

# å †å†…å­˜è®¾ç½®
export HBASE_HEAPSIZE=2048

# ä½¿ç”¨å¤–éƒ¨Hadoopé…ç½®
export HBASE_CLASSPATH=$HADOOP_HOME/etc/hadoop
```

#### Step 4: é…ç½®hbase-site.xml

```bash
vim hbase-site.xml
```

**å®Œæ•´é…ç½®å†…å®¹ï¼š**

```xml
<?xml version="1.0"?>
<?xml-stylesheet type="
```

text/xsl" href="configuration.xsl"?> <configuration> <!-- HBaseæ•°æ®å­˜å‚¨åœ¨HDFSçš„æ ¹ç›®å½• --> <property> <name>hbase.rootdir</name> <value>hdfs://master:9000/hbase</value> <description>HBaseåœ¨HDFSä¸Šçš„æ ¹ç›®å½•</description> </property>

```
<!-- HBaseé›†ç¾¤æ¨¡å¼ -->
<property>
    <name>hbase.cluster.distributed</name>
    <value>true</value>
    <description>trueè¡¨ç¤ºåˆ†å¸ƒå¼æ¨¡å¼ï¼Œfalseè¡¨ç¤ºå•æœºæ¨¡å¼</description>
</property>

<!-- ZooKeeperé›†ç¾¤åœ°å€ -->
<property>
    <name>hbase.zookeeper.quorum</name>
    <value>slave1,slave2,slave3</value>
    <description>ZooKeeperé›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨</description>
</property>

<!-- ZooKeeperå®¢æˆ·ç«¯ç«¯å£ -->
<property>
    <name>hbase.zookeeper.property.clientPort</name>
    <value>2181</value>
</property>

<!-- ZooKeeperæ•°æ®ç›®å½• -->
<property>
    <name>hbase.zookeeper.property.dataDir</name>
    <value>/usr/local/zookeeper-3.5.7/data</value>
</property>

<!-- HMasterçš„Web UIç«¯å£ -->
<property>
    <name>hbase.master.info.port</name>
    <value>16010</value>
</property>

<!-- RegionServerçš„Web UIç«¯å£ -->
<property>
    <name>hbase.regionserver.info.port</name>
    <value>16030</value>
</property>

<!-- HMasterç»‘å®šåœ°å€ -->
<property>
    <name>hbase.master.hostname</name>
    <value>master</value>
</property>

<!-- å®‰å…¨æ¨¡å¼ï¼ˆå…³é—­ï¼‰ -->
<property>
    <name>hbase.unsafe.stream.capability.enforce</name>
    <value>false</value>
</property>

<!-- WALæ–‡ä»¶çš„å‰¯æœ¬æ•° -->
<property>
    <name>hbase.wal.provider</name>
    <value>filesystem</value>
</property>
```

</configuration> ```

#### Step 5: é…ç½®regionservers

```bash
vim regionservers
```

**å†…å®¹ï¼š**

```
slave1
slave2
slave3
```

#### Step 6: é…ç½®backup-mastersï¼ˆå¯é€‰ï¼‰

```bash
# åˆ›å»ºbackup-mastersæ–‡ä»¶ï¼Œé…ç½®å¤‡ç”¨Master
vim backup-masters
```

**å†…å®¹ï¼š**

```
slave1
```

#### Step 7: é…ç½®ç¯å¢ƒå˜é‡

```bash
vim /etc/profile
```

**æ·»åŠ ï¼š**

```bash
export HBASE_HOME=/usr/local/hbase-2.2.7
export PATH=$PATH:$HBASE_HOME/bin
```

**ä½¿é…ç½®ç”Ÿæ•ˆï¼š**

```bash
source /etc/profile
```

#### Step 8: åˆ†å‘åˆ°å…¶ä»–èŠ‚ç‚¹

```bash
# åˆ†å‘HBaseç›®å½•
scp -r /usr/local/hbase-2.2.7 root@slave1:/usr/local/
scp -r /usr/local/hbase-2.2.7 root@slave2:/usr/local/
scp -r /usr/local/hbase-2.2.7 root@slave3:/usr/local/

# åˆ†å‘ç¯å¢ƒå˜é‡
scp /etc/profile root@slave1:/etc/
scp /etc/profile root@slave2:/etc/
scp /etc/profile root@slave3:/etc/

# åˆ·æ–°ç¯å¢ƒå˜é‡
ssh root@slave1 "source /etc/profile"
ssh root@slave2 "source /etc/profile"
ssh root@slave3 "source /etc/profile"
```

#### Step 9: å¯åŠ¨HBaseé›†ç¾¤

```bash
# 1. ç¡®ä¿Hadoopå·²å¯åŠ¨
start-all.sh

# 2. ç¡®ä¿ZooKeeperå·²å¯åŠ¨ï¼ˆåœ¨æ‰€æœ‰ZKèŠ‚ç‚¹ï¼‰
zkServer.sh start  # slave1
ssh root@slave2 "zkServer.sh start"
ssh root@slave3 "zkServer.sh start"

# 3. åœ¨masterèŠ‚ç‚¹å¯åŠ¨HBase
start-hbase.sh
```

**å¯åŠ¨æˆåŠŸè¾“å‡ºï¼š**

```
running master, logging to /usr/local/hbase-2.2.7/logs/hbase-root-master-master.out
slave1: running regionserver, logging to /usr/local/hbase-2.2.7/logs/hbase-root-regionserver-slave1.out
slave2: running regionserver, logging to /usr/local/hbase-2.2.7/logs/hbase-root-regionserver-slave2.out
slave3: running regionserver, logging to /usr/local/hbase-2.2.7/logs/hbase-root-regionserver-slave3.out
```

#### Step 10: éªŒè¯é›†ç¾¤

**1. ä½¿ç”¨jpså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹**

```bash
# åœ¨masterèŠ‚ç‚¹
jps
# åº”çœ‹åˆ°ï¼šHMaster

# åœ¨slave1/slave2/slave3èŠ‚ç‚¹
jps
# åº”çœ‹åˆ°ï¼šHRegionServer, QuorumPeerMain(ZK)
```

**2. è®¿é—®Web UI**

```
HMaster UI:    http://192.168.128.130:16010
RegionServer:  http://192.168.128.131:16030
```

**3. ä½¿ç”¨HBase Shell**

```bash
hbase shell

# æŸ¥çœ‹çŠ¶æ€
hbase(main):001:0> status
# è¾“å‡ºé›†ç¾¤çŠ¶æ€ä¿¡æ¯

# æŸ¥çœ‹ç‰ˆæœ¬
hbase(main):002:0> version
# è¾“å‡ºHBaseç‰ˆæœ¬

# é€€å‡º
hbase(main):003:0> exit
```

#### Step 11: åœæ­¢HBaseé›†ç¾¤

```bash
# åœæ­¢HBase
stop-hbase.sh

# åœæ­¢ZooKeeperï¼ˆåœ¨æ‰€æœ‰ZKèŠ‚ç‚¹ï¼‰
zkServer.sh stop
ssh root@slave2 "zkServer.sh stop"
ssh root@slave3 "zkServer.sh stop"

# åœæ­¢Hadoop
stop-all.sh
```

### 3.3 å¯åŠ¨é¡ºåºæ€»ç»“

```
æ­£ç¡®çš„å¯åŠ¨é¡ºåºï¼š
1. Hadoop (HDFS + YARN)
   â””â”€â”€ start-all.sh

2. ZooKeeper (æ‰€æœ‰èŠ‚ç‚¹)
   â””â”€â”€ zkServer.sh start

3. HBase
   â””â”€â”€ start-hbase.sh

åœæ­¢é¡ºåºï¼ˆç›¸åï¼‰ï¼š
1. HBase
   â””â”€â”€ stop-hbase.sh

2. ZooKeeper (æ‰€æœ‰èŠ‚ç‚¹)
   â””â”€â”€ zkServer.sh stop

3. Hadoop
   â””â”€â”€ stop-all.sh
```

------

## ç¬¬å››éƒ¨åˆ†ï¼šHBase Shellå‘½ä»¤è¯¦è§£

### 4.1 è¿›å…¥HBase Shell

```bash
# å¯åŠ¨HBase Shell
hbase shell

# æˆåŠŸè¿›å…¥åæ˜¾ç¤ºï¼š
HBase Shell
Use "help" to get list of supported commands.
Use "exit" to quit this interactive shell.
Version 2.2.7, rUnknown, Mon Jan 01 00:00:00 UTC 2024

hbase(main):001:0>
```

### 4.2 é€šç”¨å‘½ä»¤

```ruby
# æŸ¥çœ‹çŠ¶æ€
status
# è¾“å‡ºï¼š1 active master, 0 backup masters, 3 servers

# æŸ¥çœ‹ç‰ˆæœ¬
version

# æŸ¥çœ‹å½“å‰ç”¨æˆ·
whoami

# è·å–å¸®åŠ©
help
help "create"  # æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©

# é€€å‡ºShell
exit
quit
```

### 4.3 DDLå‘½ä»¤ï¼ˆæ•°æ®å®šä¹‰ï¼‰

#### åˆ›å»ºè¡¨

```ruby
# åŸºæœ¬è¯­æ³•
create 'table_name', 'column_family'

# ç¤ºä¾‹1ï¼šåˆ›å»ºå•åˆ—æ—è¡¨
create 'student', 'info'

# ç¤ºä¾‹2ï¼šåˆ›å»ºå¤šåˆ—æ—è¡¨
create 'user', 'basic', 'contact', 'address'

# ç¤ºä¾‹3ï¼šåˆ›å»ºè¡¨å¹¶è®¾ç½®å±æ€§
create 'employee', 
  {NAME => 'info', VERSIONS => 3, TTL => 2592000},
  {NAME => 'salary', VERSIONS => 5, COMPRESSION => 'SNAPPY'}

# å‚æ•°è¯´æ˜ï¼š
# VERSIONS: ä¿ç•™çš„ç‰ˆæœ¬æ•°
# TTL: æ•°æ®å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰
# COMPRESSION: å‹ç¼©æ–¹å¼ï¼ˆNONE, SNAPPY, LZO, GZï¼‰
# BLOCKSIZE: HFileå—å¤§å°ï¼ˆé»˜è®¤64KBï¼‰
```

#### æŸ¥çœ‹è¡¨ä¿¡æ¯

```ruby
# åˆ—å‡ºæ‰€æœ‰è¡¨
list

# æŸ¥çœ‹è¡¨ç»“æ„
describe 'student'

# æŸ¥çœ‹è¡¨æ˜¯å¦å­˜åœ¨
exists 'student'

# æŸ¥çœ‹è¡¨æ˜¯å¦å¯ç”¨
is_enabled 'student'
is_disabled 'student'
```

#### ä¿®æ”¹è¡¨

```ruby
# æ·»åŠ åˆ—æ—
alter 'student', NAME => 'score'

# åˆ é™¤åˆ—æ—
alter 'student', 'delete' => 'score'

# ä¿®æ”¹åˆ—æ—å±æ€§
alter 'student', 
  {NAME => 'info', VERSIONS => 5}

# ä¿®æ”¹è¡¨å±æ€§
alter 'student', 
  MAX_FILESIZE => '10737418240'  # 10GB
```

#### å¯ç”¨/ç¦ç”¨è¡¨

```ruby
# ç¦ç”¨è¡¨ï¼ˆä¿®æ”¹æˆ–åˆ é™¤è¡¨å‰å¿…é¡»å…ˆç¦ç”¨ï¼‰
disable 'student'

# å¯ç”¨è¡¨
enable 'student'

# æ£€æŸ¥è¡¨çŠ¶æ€
is_enabled 'student'
```

#### åˆ é™¤è¡¨

```ruby
# åˆ é™¤è¡¨ï¼ˆå¿…é¡»å…ˆç¦ç”¨ï¼‰
disable 'student'
drop 'student'

# æ¸…ç©ºè¡¨æ•°æ®ï¼ˆä¿ç•™è¡¨ç»“æ„ï¼‰
truncate 'student'
# ç­‰ä»·äºï¼šdisable â†’ drop â†’ create
```

### 4.4 DMLå‘½ä»¤ï¼ˆæ•°æ®æ“ä½œï¼‰

#### æ’å…¥/æ›´æ–°æ•°æ®

```ruby
# åŸºæœ¬è¯­æ³•
put 'table', 'rowkey', 'column_family:column', 'value'

# ç¤ºä¾‹1ï¼šæ’å…¥å•ä¸ªå­—æ®µ
put 'student', '001', 'info:name', 'å¼ ä¸‰'

# ç¤ºä¾‹2ï¼šæ’å…¥å¤šä¸ªå­—æ®µ
put 'student', '001', 'info:age', '20'
put 'student', '001', 'info:gender', 'ç”·'
put 'student', '001', 'info:major', 'CS'

# ç¤ºä¾‹3ï¼šæŒ‡å®šæ—¶é—´æˆ³
put 'student', '001', 'info:name', 'å¼ ä¸‰', 1234567890

# æ‰¹é‡æ’å…¥ï¼ˆåˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼‰
# æ–‡ä»¶ï¼šinsert_data.txt
put 'student', '002', 'info:name', 'æå››'
put 'student', '002', 'info:age', '21'
put 'student', '003', 'info:name', 'ç‹äº”'

# æ‰§è¡Œè„šæœ¬
hbase shell insert_data.txt
```

#### æŸ¥è¯¢æ•°æ®

**1. getå‘½ä»¤ï¼ˆæŸ¥è¯¢å•è¡Œï¼‰**

```ruby
# æŸ¥è¯¢æ•´è¡Œ
get 'student', '001'

# æŸ¥è¯¢æŒ‡å®šåˆ—æ—
get 'student', '001', 'info'

# æŸ¥è¯¢æŒ‡å®šåˆ—
get 'student', '001', 'info:name'

# æŸ¥è¯¢å¤šä¸ªåˆ—
get 'student', '001', 'info:name', 'info:age'

# æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬
get 'student', '001', {COLUMN => 'info:name', VERSIONS => 3}

# æŸ¥è¯¢æŒ‡å®šæ—¶é—´æˆ³
get 'student', '001', {COLUMN => 'info:name', TIMESTAMP => 1234567890}

# æŸ¥è¯¢æ—¶é—´èŒƒå›´
get 'student', '001', {TIMERANGE => [1234567890, 1234567900]}
```

**2. scanå‘½ä»¤ï¼ˆæ‰«æå¤šè¡Œï¼‰**

```ruby
# å…¨è¡¨æ‰«æ
scan 'student'

# é™åˆ¶è¿”å›è¡Œæ•°
scan 'student', {LIMIT => 10}

# æ‰«ææŒ‡å®šåˆ—æ—
scan 'student', {COLUMNS => 'info'}

# æ‰«ææŒ‡å®šåˆ—
scan 'student', {COLUMNS => 'info:name'}

# RowKeyèŒƒå›´æ‰«æï¼ˆå‰é—­åå¼€ï¼‰
scan 'student', {STARTROW => '001', ENDROW => '100'}

# åªæ‰«ææŒ‡å®šRowKeyåŠä¹‹å
scan 'student', {STARTROW => '050'}

# åå‘æ‰«æ
scan 'student', {REVERSED => true}

# è¿‡æ»¤å™¨æ‰«æ
scan 'student', {FILTER => "ValueFilter(=, 'binary:å¼ ä¸‰')"}

# ç»„åˆæ¡ä»¶
scan 'student', {
  STARTROW => '001',
  ENDROW => '100',
  COLUMNS => ['info:name', 'info:age'],
  LIMIT => 50,
  VERSIONS => 2
}
```

**3. countå‘½ä»¤ï¼ˆç»Ÿè®¡è¡Œæ•°ï¼‰**

```ruby
# ç»Ÿè®¡è¡¨çš„è¡Œæ•°
count 'student'

# è®¾ç½®ç»Ÿè®¡é—´éš”ï¼ˆé»˜è®¤1000è¡Œï¼‰
count 'student', INTERVAL => 100

# ä½¿ç”¨ç¼“å­˜åŠ é€Ÿ
count 'student', CACHE => 1000
```

#### åˆ é™¤æ•°æ®

```ruby
# åˆ é™¤æŒ‡å®šåˆ—çš„æœ€æ–°ç‰ˆæœ¬
delete 'student', '001', 'info:age'

# åˆ é™¤æŒ‡å®šåˆ—çš„æŒ‡å®šç‰ˆæœ¬
delete 'student', '001', 'info:age', 1234567890

# åˆ é™¤æ•´è¡Œæ‰€æœ‰åˆ—
deleteall 'student', '001'

# åˆ é™¤æ•´è¡Œçš„æŒ‡å®šåˆ—æ—
deleteall 'student', '001', 'info'
```

#### å¢åŠ è®¡æ•°å™¨

```ruby
# å¢åŠ è®¡æ•°å™¨ï¼ˆé»˜è®¤å¢åŠ 1ï¼‰
incr 'counter_table', 'row1', 'info:count', 1

# å¢åŠ æŒ‡å®šå€¼
incr 'counter_table', 'row1', 'info:count', 10

# è·å–å½“å‰è®¡æ•°å€¼
get_counter 'counter_table', 'row1', 'info:count'
```

### 4.5 é«˜çº§æŸ¥è¯¢

#### ä½¿ç”¨è¿‡æ»¤å™¨

```ruby
# 1. RowKeyè¿‡æ»¤å™¨
scan 'student', {FILTER => "PrefixFilter('00')"}

# 2. åˆ—å€¼è¿‡æ»¤å™¨
scan 'student', {FILTER => "ValueFilter(=, 'binary:å¼ ä¸‰')"}

# 3. åˆ—åè¿‡æ»¤å™¨
scan 'student', {FILTER => "QualifierFilter(=, 'binary:name')"}

# 4. å•åˆ—å€¼è¿‡æ»¤å™¨
scan 'student', {
  FILTER => "SingleColumnValueFilter('info', 'age', >, 'binary:20')"
}

# 5. ç»„åˆè¿‡æ»¤å™¨ï¼ˆANDï¼‰
scan 'student', {
  FILTER => "
    FilterList(MUST_PASS_ALL, 
      SingleColumnValueFilter('info', 'age', >, 'binary:20'),
      SingleColumnValueFilter('info', 'gender', =, 'binary:ç”·')
    )
  "
}

# 6. ç»„åˆè¿‡æ»¤å™¨ï¼ˆORï¼‰
scan 'student', {
  FILTER => "
    FilterList(MUST_PASS_ONE,
      SingleColumnValueFilter('info', 'major', =, 'binary:CS'),
      SingleColumnValueFilter('info', 'major', =, 'binary:IS')
    )
  "
}
```

### 4.6 å®æˆ˜ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šåˆ›å»ºç”µå½±è¯„åˆ†è¡¨

```ruby
# åˆ›å»ºè¡¨
create 'movie_ratings', 
  {NAME => 'info', VERSIONS => 3},
  {NAME => 'stats', VERSIONS => 1}

# æ’å…¥æ•°æ®
put 'movie_ratings', 'movie_001', 'info:title', 'Toy Story'
put 'movie_ratings', 'movie_001', 'info:genre', 'Animation'
put 'movie_ratings', 'movie_001', 'stats:avg_rating', '4.5'
put 'movie_ratings', 'movie_001', 'stats:count', '1000'

# æŸ¥è¯¢
get 'movie_ratings', 'movie_001'

# æ‰«ææ‰€æœ‰ç”µå½±
scan 'movie_ratings', {LIMIT => 10}
```

#### ç¤ºä¾‹2ï¼šç”¨æˆ·ä¿¡æ¯è¡¨æ“ä½œ

```ruby
# åˆ›å»ºç”¨æˆ·è¡¨
create 'users', 
  {NAME => 'basic', VERSIONS => 2},
  {NAME => 'preference', VERSIONS => 1}

# æ‰¹é‡æ’å…¥
put 'users', 'user_001', 'basic:name', 'å¼ ä¸‰'
put 'users', 'user_001', 'basic:age', '25'
put 'users', 'user_001', 'basic:gender', 'M'
put 'users', 'user_001', 'preference:genre', 'Action'

put 'users', 'user_002', 'basic:name', 'æå››'
put 'users', 'user_002', 'basic:age', '30'
put 'users', 'user_002', 'basic:gender', 'F'
put 'users', 'user_002', 'preference:genre', 'Romance'

# æŸ¥è¯¢25å²ä»¥ä¸Šçš„ç”¨æˆ·
scan 'users', {
  FILTER => "SingleColumnValueFilter('basic', 'age', >, 'binary:25')"
}

# æŸ¥è¯¢ç”·æ€§ç”¨æˆ·
scan 'users', {
  FILTER => "SingleColumnValueFilter('basic', 'gender', =, 'binary:M')"
}

# ç»Ÿè®¡ç”¨æˆ·æ•°
count 'users'
```

------

## ç¬¬äº”éƒ¨åˆ†ï¼šHBase Java APIç¼–ç¨‹

### 5.1 å¼€å‘ç¯å¢ƒæ­å»º

#### Step 1: åˆ›å»ºMavené¡¹ç›®

**pom.xmlé…ç½®ï¼š**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.movie</groupId>
    <artifactId>hbase-movie-analysis</artifactId>
    <version>1.0-SNAPSHOT</version>
    
    <properties>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <hbase.version>2.2.7</hbase.version>
        <hadoop.version>3.3.6</hadoop.version>
    </properties>
    
    <dependencies>
        <!-- HBaseå®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.apache.hbase</groupId>
            <artifactId>hbase-client</artifactId>
            <version>${hbase.version}</version>
        </dependency>
        
        <!-- HBaseæœåŠ¡ç«¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰ -->
        <dependency>
            <groupId>org.apache.hbase</groupId>
            <artifactId>hbase-server</artifactId>
            <version>${hbase.version}</version>
        </dependency>
        
        <!-- Hadoopå®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.apache.hadoop</groupId>
            <artifactId>hadoop-common</artifactId>
            <version>${hadoop.version}</version>
        </dependency>
        
        <dependency>
            <groupId>org.apache.hadoop</groupId>
            <artifactId>hadoop-hdfs</artifactId>
            <version>${hadoop.version}</version>
        </dependency>
        
        <!-- æ—¥å¿— -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-log4j12</artifactId>
            <version>1.7.30</version>
        </dependency>
        
        <!-- JUnitæµ‹è¯• -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

#### Step 2: åˆ›å»ºé…ç½®æ–‡ä»¶

**log4j.propertiesï¼š**

```properties
log4j.rootLogger=INFO, stdout
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n
```

### 5.2 HBaseå·¥å…·ç±»

**HBaseUtil.javaï¼š**

```java
package com.movie.hbase.util;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.hbase.*;
import org.apache.hadoop.hbase.client.*;
import org.apache.hadoop.hbase.util.Bytes;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class HBaseUtil {
    
    // HBaseé…ç½®
    private static Configuration conf;
    private static Connection connection;
    
    // é™æ€åˆå§‹åŒ–é…ç½®
    static {
        try {
            // åˆ›å»ºé…ç½®å¯¹è±¡
            conf = HBaseConfiguration.create();
            
            // è®¾ç½®ZooKeeperé›†ç¾¤åœ°å€
            conf.set("hbase.zookeeper.quorum", "slave1,slave2,slave3");
            conf.set("hbase.zookeeper.property.clientPort", "2181");
            
            // åˆ›å»ºè¿æ¥
            connection = ConnectionFactory.createConnection(conf);
            
            System.out.println("HBaseè¿æ¥åˆ›å»ºæˆåŠŸï¼");
            
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    /**
     * è·å–HBaseè¿æ¥
     */
    public static Connection getConnection() {
        return connection;
    }
    
    /**
     * å…³é—­è¿æ¥
     */
    public static void closeConnection() {
        if (connection != null) {
            try {
                connection.close();
                System.out.println("HBaseè¿æ¥å·²å…³é—­ï¼");
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
    
    /**
     * åˆ›å»ºè¡¨
     * @param tableName è¡¨å
     * @param columnFamilies åˆ—æ—åæ•°ç»„
     */
    public static void createTable(String tableName, String[] columnFamilies) 
            throws IOException {
        
        Admin admin = connection.getAdmin();
        
        TableName table = TableName.valueOf(tableName);
        
        // åˆ¤æ–­è¡¨æ˜¯å¦å­˜åœ¨
        if (admin.tableExists(table)) {
            System.out.println("è¡¨ " + tableName + " å·²å­˜åœ¨ï¼");
            return;
        }
        
        // åˆ›å»ºè¡¨æè¿°å™¨
        TableDescriptorBuilder tableBuilder = 
            TableDescriptorBuilder.newBuilder(table);
        
        // æ·»åŠ åˆ—æ—
        for (String cf : columnFamilies) {
            ColumnFamilyDescriptor cfDesc = 
                ColumnFamilyDescriptorBuilder
                    .newBuilder(Bytes.toBytes(cf))
                    .setMaxVersions(3)  // è®¾ç½®æœ€å¤§ç‰ˆæœ¬æ•°
                    .build();
            tableBuilder.setColumnFamily(cfDesc);
        }
        
        // åˆ›å»ºè¡¨
        admin.createTable(tableBuilder.build());
        System.out.println("è¡¨ " + tableName + " åˆ›å»ºæˆåŠŸï¼");
        
        admin.close();
    }
    
    /**
     * åˆ é™¤è¡¨
     */
    public static void deleteTable(String tableName) throws IOException {
        Admin admin = connection.getAdmin();
        TableName table = TableName.valueOf(tableName);
        
        if (!admin.tableExists(table)) {
            System.out.println("è¡¨ " + tableName + " ä¸å­˜åœ¨ï¼");
            return;
        }
        
        // ç¦ç”¨è¡¨
        admin.disableTable(table);
        // åˆ é™¤è¡¨
        admin.deleteTable(table);
        System.out.println("è¡¨ " + tableName + " åˆ é™¤æˆåŠŸï¼");
        
        admin.close();
    }
    
    /**
     * æ’å…¥å•æ¡æ•°æ®
     */
    public static void putData(String tableName, String rowKey, 
            String columnFamily, String column, String value) throws IOException {
        
        Table table = connection.getTable(TableName.valueOf(tableName));
        
        Put put = new Put(Bytes.toBytes(rowKey));
        put.addColumn(
            Bytes.toBytes(columnFamily),
            Bytes.toBytes(column),
            Bytes.toBytes(value)
        );
        
        table.put(put);
        System.out.println("æ•°æ®æ’å…¥æˆåŠŸï¼š" + rowKey);
        
        table.close();
    }
    
    /**
     * æ‰¹é‡æ’å…¥æ•°æ®
     */
    public static void putDataBatch(String tableName, List<Put> puts) 
            throws IOException {
        
        Table table = connection.getTable(TableName.valueOf(tableName));
        table.put(puts);
        System.out.println("æ‰¹é‡æ’å…¥ " + puts.size() + " æ¡æ•°æ®æˆåŠŸï¼");
        table.close();
    }
    
    /**
     * æŸ¥è¯¢å•è¡Œæ•°æ®
     */
    public static void getData(String tableName, String rowKey) 
            throws IOException {
        
        Table table = connection.getTable(TableName.valueOf(tableName));
        
        Get get = new Get(Bytes.toBytes(rowKey));
        Result result = table.get(get);
        
        // éå†ç»“æœ
        for (Cell cell : result.rawCells()) {
            System.out.println(
                "RowKey: " + Bytes.toString(CellUtil.cloneRow(cell)) +
                ", Family: " + Bytes.toString(CellUtil.cloneFamily(cell)) +
                ", Column: " + Bytes.toString(CellUtil.cloneQualifier(cell)) +
                ", Value: " + Bytes.toString(CellUtil.cloneValue(cell))
            );
        }
        
        table.close();
    }
    
    /**
     * æ‰«æè¡¨æ•°æ®
     */
    public static void scanTable(String tableName) throws IOException {
        Table table = connection.getTable(TableName.valueOf(tableName));
        
        Scan scan = new Scan();
        ResultScanner scanner = table.getScanner(scan);
        
        for (Result result : scanner) {
            System.out.println("===================");
            for (Cell cell : result.rawCells()) {
                System.out.println(
                    "RowKey: " + Bytes.toString(CellUtil.cloneRow(cell)) +
                    ", Family: " + Bytes.toString(CellUtil.cloneFamily(cell)) +
                    ", Column: " + Bytes.toString(CellUtil.cloneQualifier(cell)) +
                    ", Value: " + Bytes.toString(CellUtil.cloneValue(cell))
                );
            }
        }
        
        scanner.close();
        table.close();
    }
    
    /**
     * åˆ é™¤æ•°æ®
     */
    public static void deleteData(String tableName, String rowKey) 
            throws IOException {
        
        Table table = connection.getTable(TableName.valueOf(tableName));
        
        Delete delete = new Delete(Bytes.toBytes(rowKey));
        table.delete(delete);
        System.out.println("åˆ é™¤æ•°æ®æˆåŠŸï¼š" + rowKey);
        
        table.close();
    }
}
```

### 5.3 æµ‹è¯•å·¥å…·ç±»

**TestHBaseUtil.javaï¼š**

```java
package com.movie.hbase.test;

import com.movie.hbase.util.HBaseUtil;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

public class TestHBaseUtil {
    
    @Before
    public void setUp() {
        System.out.println("=== æµ‹è¯•å¼€å§‹ ===");
    }
    
    @After
    public void tearDown() {
        System.out.println("=== æµ‹è¯•ç»“æŸ ===");
    }
    
    @Test
    public void testCreateTable() throws Exception {
        String tableName = "test_movie";
        String[] columnFamilies = {"info", "stats"};
        HBaseUtil.createTable(tableName, columnFamilies);
    }
    
    @Test
    public void testPutData() throws Exception {
        HBaseUtil.putData("test_movie", "movie_001", 
            "info", "title", "Toy Story");
        HBaseUtil.putData("test_movie", "movie_001", 
            "info", "genre", "Animation");
        HBaseUtil.putData("test_movie", "movie_001", 
            "stats", "rating", "4.5");
    }
    
    @Test
    public void testGetData() throws Exception {
        HBaseUtil.getData("test_movie", "movie_001");
    }
    
    @Test
    public void testScanTable() throws Exception {
        HBaseUtil.scanTable("test_movie");
    }
    
    @Test
    public void testDeleteData() throws Exception {
        HBaseUtil.deleteData("test_movie", "movie_001");
    }
    
    @Test
    public void testDeleteTable() throws Exception {
        HBaseUtil.deleteTable("test_movie");
    }
}
```

------

## ç¬¬å…­éƒ¨åˆ†ï¼šç”µå½±æ•°æ®å­˜å‚¨é¡¹ç›®å®æˆ˜

### 6.1 é¡¹ç›®éœ€æ±‚åˆ†æ

**éœ€è¦å­˜å‚¨çš„4ç±»åˆ†æç»“æœï¼š**

1. **è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±**
   - æ•°æ®æ¥æºï¼šHiveåˆ†æç»“æœ
   - è¡¨åï¼šfilm_RateNum
   - RowKeyè®¾è®¡ï¼šTop1, Top2, ..., Top10
2. **ä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±**
   - æ•°æ®æ¥æºï¼šHDFSæ–‡ä»¶
   - è¡¨åï¼šfilm_GenderRatings
   - RowKeyè®¾è®¡ï¼šM_Top1, M_Top2, F_Top1, F_Top2, ...
3. **ç”µå½±IDä¸º2858çš„å„å¹´é¾„æ®µå¹³å‡è¯„åˆ†**
   - æ•°æ®æ¥æºï¼šHDFSæ–‡ä»¶
   - è¡¨åï¼šfilm_AgeRatings
   - RowKeyè®¾è®¡ï¼šAge=1, Age=18, Age=25, ...
4. **å„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨**
   - æ•°æ®æ¥æºï¼šHDFSæ–‡ä»¶
   - è¡¨åï¼šfilm_TypeRatings
   - RowKeyè®¾è®¡ï¼šAction_Top1, Comedy_Top1, ...

### 6.2 ä»»åŠ¡1ï¼šå­˜å‚¨è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±

#### è¡¨è®¾è®¡

```
è¡¨åï¼šfilm_RateNum
RowKeyï¼šTop[1
```

~10] åˆ—æ—ï¼šscoringtimes åˆ—ï¼šMovieID, Movietype, RateNum

```
#### ä»£ç å®ç°

**FilmRateNumHandler.javaï¼š**
```java
package com.movie.hbase.handler;

import com.movie.hbase.util.HBaseUtil;
import org.apache.hadoop.hbase.client.Put;
import org.apache.hadoop.hbase.util.Bytes;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class FilmRateNumHandler {
    
    private static final String TABLE_NAME = "film_RateNum";
    private static final String CF = "scoringtimes";
    
    /**
     * åˆ›å»ºè¡¨
     */
    public static void createTable() throws IOException {
        String[] columnFamilies = {CF};
        HBaseUtil.createTable(TABLE_NAME, columnFamilies);
    }
    
    /**
     * æ’å…¥è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±æ•°æ®
     */
    public static void insertTopMovies() throws IOException {
        List<Put> puts = new ArrayList<>();
        
        // æ¨¡æ‹Ÿæ•°æ®ï¼šä»HiveæŸ¥è¯¢ç»“æœè·å–
        String[][] movies = {
            {"1", "2858", "American Beauty (1999)", "2077"},
            {"2", "260", "Star Wars: Episode IV (1977)", "1711"},
            {"3", "1196", "Star Wars: Episode V (1980)", "1667"},
            {"4", "1210", "Star Wars: Episode VI (1983)", "1521"},
            {"5", "480", "Jurassic Park (1993)", "1502"},
            {"6", "2028", "Saving Private Ryan (1998)", "1500"},
            {"7", "589", "Terminator 2: Judgment Day (1991)", "1495"},
            {"8", "2571", "Matrix, The (1999)", "1480"},
            {"9", "1270", "Back to the Future (1985)", "1437"},
            {"10", "593", "Silence of the Lambs (1991)", "1410"}
        };
        
        for (String[] movie : movies) {
            String rank = movie[0];
            String movieId = movie[1];
            String title = movie[2];
            String rateNum = movie[3];
            
            // RowKeyè®¾è®¡ï¼šTop1, Top2, ...
            String rowKey = "Top" + rank;
            
            Put put = new Put(Bytes.toBytes(rowKey));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("MovieID"), Bytes.toBytes(movieId));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Movietype"), Bytes.toBytes(title));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("RateNum"), Bytes.toBytes(rateNum));
            
            puts.add(put);
        }
        
        // æ‰¹é‡æ’å…¥
        HBaseUtil.putDataBatch(TABLE_NAME, puts);
    }
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰æ•°æ®
     */
    public static void queryAll() throws IOException {
        System.out.println("\n=== è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½± ===");
        HBaseUtil.scanTable(TABLE_NAME);
    }
    
    /**
     * æŸ¥è¯¢Top1ç”µå½±
     */
    public static void queryTop1() throws IOException {
        System.out.println("\n=== Top1ç”µå½±ä¿¡æ¯ ===");
        HBaseUtil.getData(TABLE_NAME, "Top1");
    }
    
    public static void main(String[] args) throws IOException {
        // 1. åˆ›å»ºè¡¨
        createTable();
        
        // 2. æ’å…¥æ•°æ®
        insertTopMovies();
        
        // 3. æŸ¥è¯¢æ•°æ®
        queryAll();
        queryTop1();
        
        // 4. å…³é—­è¿æ¥
        HBaseUtil.closeConnection();
    }
}
```

### 6.3 ä»»åŠ¡2ï¼šå­˜å‚¨ä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±

#### è¡¨è®¾è®¡

```
è¡¨åï¼šfilm_GenderRatings
RowKeyï¼šM_Top[1~10], F_Top[1~10]
åˆ—æ—ï¼šinfo
åˆ—ï¼šMovieID, Rating
```

#### ä»HDFSè¯»å–æ•°æ®çš„å·¥å…·ç±»

**HDFSUtil.javaï¼š**

```java
package com.movie.hbase.util;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FSDataInputStream;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;

public class HDFSUtil {
    
    private static Configuration conf;
    private static FileSystem fs;
    
    static {
        try {
            conf = new Configuration();
            conf.set("fs.defaultFS", "hdfs://master:9000");
            fs = FileSystem.get(conf);
            System.out.println("HDFSè¿æ¥åˆ›å»ºæˆåŠŸï¼");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    /**
     * è¯»å–HDFSæ–‡ä»¶å†…å®¹
     * @param path HDFSæ–‡ä»¶è·¯å¾„
     * @return æ–‡ä»¶å†…å®¹åˆ—è¡¨
     */
    public static List<String> readFile(String path) throws IOException {
        List<String> lines = new ArrayList<>();
        
        FSDataInputStream in = fs.open(new Path(path));
        BufferedReader reader = new BufferedReader(
            new InputStreamReader(in, "UTF-8"));
        
        String line;
        while ((line = reader.readLine()) != null) {
            lines.add(line);
        }
        
        reader.close();
        in.close();
        
        return lines;
    }
    
    /**
     * å…³é—­HDFSè¿æ¥
     */
    public static void closeFileSystem() {
        if (fs != null) {
            try {
                fs.close();
                System.out.println("HDFSè¿æ¥å·²å…³é—­ï¼");
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

#### ä»£ç å®ç°

**FilmGenderRatingsHandler.javaï¼š**

```java
package com.movie.hbase.handler;

import com.movie.hbase.util.HBaseUtil;
import com.movie.hbase.util.HDFSUtil;
import org.apache.hadoop.hbase.client.Put;
import org.apache.hadoop.hbase.util.Bytes;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class FilmGenderRatingsHandler {
    
    private static final String TABLE_NAME = "film_GenderRatings";
    private static final String CF = "info";
    
    /**
     * åˆ›å»ºè¡¨
     */
    public static void createTable() throws IOException {
        String[] columnFamilies = {CF};
        HBaseUtil.createTable(TABLE_NAME, columnFamilies);
    }
    
    /**
     * ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
     * HDFSæ–‡ä»¶æ ¼å¼ï¼šGender\tMovieID\tTitle\tAvgRating
     */
    public static void insertFromHDFS(String hdfsPath) throws IOException {
        // è¯»å–HDFSæ–‡ä»¶
        List<String> lines = HDFSUtil.readFile(hdfsPath);
        
        List<Put> puts = new ArrayList<>();
        int maleRank = 1;
        int femaleRank = 1;
        
        for (String line : lines) {
            String[] fields = line.split("\t");
            if (fields.length < 4) continue;
            
            String gender = fields[0];  // Mæˆ–F
            String movieId = fields[1];
            String title = fields[2];
            String avgRating = fields[3];
            
            // RowKeyè®¾è®¡ï¼šM_Top1, F_Top1, ...
            String rowKey;
            if ("M".equals(gender)) {
                rowKey = "M_Top" + maleRank++;
            } else {
                rowKey = "F_Top" + femaleRank++;
            }
            
            // åªå–å‰10å
            if (maleRank > 11 && femaleRank > 11) break;
            
            Put put = new Put(Bytes.toBytes(rowKey));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("MovieID"), Bytes.toBytes(movieId));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Title"), Bytes.toBytes(title));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Rating"), Bytes.toBytes(avgRating));
            
            puts.add(put);
        }
        
        // æ‰¹é‡æ’å…¥
        HBaseUtil.putDataBatch(TABLE_NAME, puts);
    }
    
    /**
     * æŸ¥è¯¢ç”·æ€§ç”¨æˆ·Top10
     */
    public static void queryMaleTop10() throws IOException {
        System.out.println("\n=== ç”·æ€§ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½± ===");
        for (int i = 1; i <= 10; i++) {
            HBaseUtil.getData(TABLE_NAME, "M_Top" + i);
        }
    }
    
    /**
     * æŸ¥è¯¢å¥³æ€§ç”¨æˆ·Top10
     */
    public static void queryFemaleTop10() throws IOException {
        System.out.println("\n=== å¥³æ€§ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½± ===");
        for (int i = 1; i <= 10; i++) {
            HBaseUtil.getData(TABLE_NAME, "F_Top" + i);
        }
    }
    
    public static void main(String[] args) throws IOException {
        // HDFSæ–‡ä»¶è·¯å¾„
        String hdfsPath = "/join/MoviesRatesTop10GroupByGender/part-r-00000";
        
        // 1. åˆ›å»ºè¡¨
        createTable();
        
        // 2. ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
        insertFromHDFS(hdfsPath);
        
        // 3. æŸ¥è¯¢æ•°æ®
        queryMaleTop10();
        queryFemaleTop10();
        
        // 4. å…³é—­è¿æ¥
        HDFSUtil.closeFileSystem();
        HBaseUtil.closeConnection();
    }
}
```

### 6.4 ä»»åŠ¡3ï¼šå­˜å‚¨ç”µå½±IDä¸º2858çš„å„å¹´é¾„æ®µå¹³å‡è¯„åˆ†

#### è¡¨è®¾è®¡

```
è¡¨åï¼šfilm_AgeRatings
RowKeyï¼šAge=[å¹´é¾„æ®µ]
åˆ—æ—ï¼šinfo
åˆ—ï¼šavgRating, MovieID
```

#### ä»£ç å®ç°

**FilmAgeRatingsHandler.javaï¼š**

```java
package com.movie.hbase.handler;

import com.movie.hbase.util.HBaseUtil;
import com.movie.hbase.util.HDFSUtil;
import org.apache.hadoop.hbase.client.Put;
import org.apache.hadoop.hbase.util.Bytes;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class FilmAgeRatingsHandler {
    
    private static final String TABLE_NAME = "film_AgeRatings";
    private static final String CF = "info";
    
    /**
     * åˆ›å»ºè¡¨
     */
    public static void createTable() throws IOException {
        String[] columnFamilies = {CF};
        HBaseUtil.createTable(TABLE_NAME, columnFamilies);
    }
    
    /**
     * ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
     * HDFSæ–‡ä»¶æ ¼å¼ï¼šAge\tMovieID\tTitle\tAvgRating
     */
    public static void insertFromHDFS(String hdfsPath) throws IOException {
        // è¯»å–HDFSæ–‡ä»¶
        List<String> lines = HDFSUtil.readFile(hdfsPath);
        
        List<Put> puts = new ArrayList<>();
        
        for (String line : lines) {
            String[] fields = line.split("\t");
            if (fields.length < 4) continue;
            
            String age = fields[0];          // å¹´é¾„æ®µ
            String movieId = fields[1];      // ç”µå½±ID
            String title = fields[2];        // ç”µå½±æ ‡é¢˜
            String avgRating = fields[3];    // å¹³å‡è¯„åˆ†
            
            // RowKeyè®¾è®¡ï¼šAge=1, Age=18, ...
            String rowKey = "Age=" + age;
            
            Put put = new Put(Bytes.toBytes(rowKey));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("MovieID"), Bytes.toBytes(movieId));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Title"), Bytes.toBytes(title));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("avgRating"), Bytes.toBytes(avgRating));
            
            puts.add(put);
        }
        
        // æ‰¹é‡æ’å…¥
        HBaseUtil.putDataBatch(TABLE_NAME, puts);
    }
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰å¹´é¾„æ®µçš„è¯„åˆ†
     */
    public static void queryAll() throws IOException {
        System.out.println("\n=== ç”µå½±IDä¸º2858çš„å„å¹´é¾„æ®µå¹³å‡è¯„åˆ† ===");
        HBaseUtil.scanTable(TABLE_NAME);
    }
    
    /**
     * æŸ¥è¯¢æŒ‡å®šå¹´é¾„æ®µçš„è¯„åˆ†
     */
    public static void queryByAge(String age) throws IOException {
        System.out.println("\n=== å¹´é¾„æ®µ" + age + "çš„å¹³å‡è¯„åˆ† ===");
        HBaseUtil.getData(TABLE_NAME, "Age=" + age);
    }
    
    public static void main(String[] args) throws IOException {
        // HDFSæ–‡ä»¶è·¯å¾„
        String hdfsPath = "/join/MoviesAvgScoreGroupByAge/part-r-00000";
        
        // 1. åˆ›å»ºè¡¨
        createTable();
        
        // 2. ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
        insertFromHDFS(hdfsPath);
        
        // 3. æŸ¥è¯¢æ•°æ®
        queryAll();
        queryByAge("25");  // æŸ¥è¯¢25å²å¹´é¾„æ®µ
        
        // 4. å…³é—­è¿æ¥
        HDFSUtil.closeFileSystem();
        HBaseUtil.closeConnection();
    }
}
```

### 6.5 ä»»åŠ¡4ï¼šå­˜å‚¨å„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨

#### è¡¨è®¾è®¡

```
è¡¨åï¼šfilm_TypeRatings
RowKeyï¼š[ç”µå½±ç±»å‹]_Top[1~5]
åˆ—æ—ï¼šinfo
åˆ—ï¼šMovieID, Rating
```

#### ä»£ç å®ç°

**FilmTypeRatingsHandler.javaï¼š**

```java
package com.movie.hbase.handler;

import com.movie.hbase.util.HBaseUtil;
import com.movie.hbase.util.HDFSUtil;
import org.apache.hadoop.hbase.client.Put;
import org.apache.hadoop.hbase.util.Bytes;
import java.io.IOException;
import java.util.*;

public class FilmTypeRatingsHandler {
    
    private static final String TABLE_NAME = "film_TypeRatings";
    private static final String CF = "info";
    
    /**
     * åˆ›å»ºè¡¨
     */
    public static void createTable() throws IOException {
        String[] columnFamilies = {CF};
        HBaseUtil.createTable(TABLE_NAME, columnFamilies);
    }
    
    /**
     * ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
     * HDFSæ–‡ä»¶æ ¼å¼ï¼šGenre\tMovieID\tTitle\tAvgRating
     */
    public static void insertFromHDFS(String hdfsPath) throws IOException {
        // è¯»å–HDFSæ–‡ä»¶
        List<String> lines = HDFSUtil.readFile(hdfsPath);
        
        // æŒ‰ç±»å‹åˆ†ç»„ç»Ÿè®¡
        Map<String, Integer> genreRankMap = new HashMap<>();
        List<Put> puts = new ArrayList<>();
        
        for (String line : lines) {
            String[] fields = line.split("\t");
            if (fields.length < 4) continue;
            
            String genre = fields[0];        // ç”µå½±ç±»å‹
            String movieId = fields[1];      // ç”µå½±ID
            String title = fields[2];        // ç”µå½±æ ‡é¢˜
            String avgRating = fields[3];    // å¹³å‡è¯„åˆ†
            
            // è·å–å½“å‰ç±»å‹çš„æ’å
            int rank = genreRankMap.getOrDefault(genre, 0) + 1;
            genreRankMap.put(genre, rank);
            
            // åªå–æ¯ä¸ªç±»å‹çš„Top5
            if (rank > 5) continue;
            
            // RowKeyè®¾è®¡ï¼šAction_Top1, Comedy_Top2, ...
            String rowKey = genre + "_Top" + rank;
            
            Put put = new Put(Bytes.toBytes(rowKey));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("MovieID"), Bytes.toBytes(movieId));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Title"), Bytes.toBytes(title));
            put.addColumn(Bytes.toBytes(CF), 
                Bytes.toBytes("Rating"), Bytes.toBytes(avgRating));
            
            puts.add(put);
        }
        
        // æ‰¹é‡æ’å…¥
        HBaseUtil.putDataBatch(TABLE_NAME, puts);
    }
    
    /**
     * æŸ¥è¯¢æŒ‡å®šç±»å‹çš„Top5ç”µå½±
     */
    public static void queryByGenre(String genre) throws IOException {
        System.out.println("\n=== " + genre + "ç±»å‹è¯„åˆ†æœ€é«˜çš„5éƒ¨ç”µå½± ===");
        for (int i = 1; i <= 5; i++) {
            String rowKey = genre + "_Top" + i;
            HBaseUtil.getData(TABLE_NAME, rowKey);
        }
    }
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰æ•°æ®
     */
    public static void queryAll() throws IOException {
        System.out.println("\n=== å„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨ ===");
        HBaseUtil.scanTable(TABLE_NAME);
    }
    
    public static void main(String[] args) throws IOException {
        // HDFSæ–‡ä»¶è·¯å¾„
        String hdfsPath = "/join/outputTop5/part-r-00000";
        
        // 1. åˆ›å»ºè¡¨
        createTable();
        
        // 2. ä»HDFSè¯»å–å¹¶æ’å…¥æ•°æ®
        insertFromHDFS(hdfsPath);
        
        // 3. æŸ¥è¯¢æ•°æ®
        queryByGenre("Action");    // æŸ¥è¯¢åŠ¨ä½œç‰‡Top5
        queryByGenre("Comedy");    // æŸ¥è¯¢å–œå‰§ç‰‡Top5
        queryAll();                // æŸ¥è¯¢æ‰€æœ‰
        
        // 4. å…³é—­è¿æ¥
        HDFSUtil.closeFileSystem();
        HBaseUtil.closeConnection();
    }
}
```

### 6.6 å®Œæ•´é¡¹ç›®ä¸»ç¨‹åº

**MovieAnalysisMain.javaï¼š**

```java
package com.movie.hbase;

import com.movie.hbase.handler.*;
import com.movie.hbase.util.HBaseUtil;
import com.movie.hbase.util.HDFSUtil;
import java.io.IOException;

public class MovieAnalysisMain {
    
    public static void main(String[] args) {
        try {
            System.out.println("========================================");
            System.out.println("   ç”µå½±ç”¨æˆ·å½±è¯„åˆ†æç»“æœå­˜å‚¨ç³»ç»Ÿ");
            System.out.println("========================================\n");
            
            // ä»»åŠ¡1ï¼šå­˜å‚¨è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±
            System.out.println(">>> ä»»åŠ¡1ï¼šå­˜å‚¨è¯„åˆ†æ¬¡æ•°æœ€å¤šçš„10éƒ¨ç”µå½±");
            FilmRateNumHandler.createTable();
            FilmRateNumHandler.insertTopMovies();
            FilmRateNumHandler.queryAll();
            
            // ä»»åŠ¡2ï¼šå­˜å‚¨ä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±
            System.out.println("\n>>> ä»»åŠ¡2ï¼šå­˜å‚¨ä¸åŒæ€§åˆ«ç”¨æˆ·è¯„åˆ†æœ€é«˜çš„10éƒ¨ç”µå½±");
            String genderPath = "/join/MoviesRatesTop10GroupByGender/part-r-00000";
            FilmGenderRatingsHandler.createTable();
            FilmGenderRatingsHandler.insertFromHDFS(genderPath);
            FilmGenderRatingsHandler.queryMaleTop10();
            FilmGenderRatingsHandler.queryFemaleTop10();
            
            // ä»»åŠ¡3ï¼šå­˜å‚¨ç”µå½±IDä¸º2858çš„å„å¹´é¾„æ®µå¹³å‡è¯„åˆ†
            System.out.println("\n>>> ä»»åŠ¡3ï¼šå­˜å‚¨ç”µå½±IDä¸º2858çš„å„å¹´é¾„æ®µå¹³å‡è¯„åˆ†");
            String agePath = "/join/MoviesAvgScoreGroupByAge/part-r-00000";
            FilmAgeRatingsHandler.createTable();
            FilmAgeRatingsHandler.insertFromHDFS(agePath);
            FilmAgeRatingsHandler.queryAll();
            
            // ä»»åŠ¡4ï¼šå­˜å‚¨å„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨
            System.out.println("\n>>> ä»»åŠ¡4ï¼šå­˜å‚¨å„ç±»å‹ç”µå½±è¯„åˆ†æœ€é«˜çš„5éƒ¨ç”µå½±");
            String typePath = "/join/outputTop5/part-r-00000";
            FilmTypeRatingsHandler.createTable();
            FilmTypeRatingsHandler.insertFromHDFS(typePath);
            FilmTypeRatingsHandler.queryByGenre("Action");
            FilmTypeRatingsHandler.queryByGenre("Drama");
            
            System.out.println("\n========================================");
            System.out.println("   æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼");
            System.out.println("========================================");
            
        } catch (IOException e) {
            System.err.println("æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š" + e.getMessage());
            e.printStackTrace();
        } finally {
            // å…³é—­è¿æ¥
            HDFSUtil.closeFileSystem();
            HBaseUtil.closeConnection();
        }
    }
}
```

### 6.7 è¿è¡Œä¸éªŒè¯

#### 1. æ‰“åŒ…é¡¹ç›®

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
mvn clean package

# ç”Ÿæˆçš„jaråŒ…ä½äºtargetç›®å½•
# hbase-movie-analysis-1.0-SNAPSHOT.jar
```

#### 2. ä¸Šä¼ å¹¶è¿è¡Œ

```bash
# ä¸Šä¼ jaråŒ…åˆ°masterèŠ‚ç‚¹
scp target/hbase-movie-analysis-1.0-SNAPSHOT.jar root@master:/opt/

# åœ¨masterèŠ‚ç‚¹è¿è¡Œ
cd /opt
java -cp hbase-movie-analysis-1.0-SNAPSHOT.jar \
  com.movie.hbase.MovieAnalysisMain
```

#### 3. éªŒè¯æ•°æ®

**æ–¹æ³•1ï¼šä½¿ç”¨HBase Shell**

```bash
hbase shell

# æŸ¥çœ‹æ‰€æœ‰è¡¨
list

# æŸ¥çœ‹è¡¨ç»“æ„
describe 'film_RateNum'

# æŸ¥è¯¢æ•°æ®
scan 'film_RateNum'
get 'film_RateNum', 'Top1'

scan 'film_GenderRatings'
get 'film_GenderRatings', 'M_Top1'

scan 'film_AgeRatings'
get 'film_AgeRatings', 'Age=25'

scan 'film_TypeRatings'
get 'film_TypeRatings', 'Action_Top1'
```

**æ–¹æ³•2ï¼šä½¿ç”¨Web UI**

```
è®¿é—®ï¼šhttp://192.168.128.130:16010

1. ç‚¹å‡»"Table Details"
2. é€‰æ‹©å¯¹åº”çš„è¡¨
3. æŸ¥çœ‹è¡¨çš„Regionåˆ†å¸ƒå’Œæ•°æ®
```

------

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 7.1 RowKeyè®¾è®¡åŸåˆ™

#### åŸåˆ™1ï¼šé¿å…çƒ­ç‚¹é—®é¢˜

**âŒ é”™è¯¯è®¾è®¡ï¼ˆé¡ºåºRowKeyï¼‰ï¼š**

```
user_20240101_001
user_20240101_002
user_20240101_003
...
â†“ é—®é¢˜ï¼šæ‰€æœ‰æ•°æ®å†™å…¥åŒä¸€ä¸ªRegion
```

**âœ… æ­£ç¡®è®¾è®¡ï¼ˆæ•£åˆ—RowKeyï¼‰ï¼š**

```
æ–¹æ³•1ï¼šåŠ ç›ï¼ˆSaltingï¼‰
hash(user_id)%10 + "_" + user_id + "_" + timestamp
ä¾‹å¦‚ï¼š3_user001_20240101

æ–¹æ³•2ï¼šåè½¬ï¼ˆReversingï¼‰
20240101 â†’ 10140202
```

#### åŸåˆ™2ï¼šå®šé•¿è®¾è®¡

```java
// âœ… æ¨èï¼šå®šé•¿RowKey
String rowKey = String.format("%010d_%s", userId, timestamp);
// ç»“æœï¼š0000001234_20240101

// âŒ ä¸æ¨èï¼šå˜é•¿RowKey
String rowKey = userId + "_" + timestamp;
// ç»“æœï¼š1234_20240101ï¼ˆé•¿åº¦ä¸ä¸€è‡´ï¼‰
```

#### åŸåˆ™3ï¼šå¯è¯»æ€§

```
ä¸šåŠ¡å‰ç¼€ + æ—¶é—´æˆ³ + å”¯ä¸€ID
order_20240101_12345678
movie_2024_action_001
user_north_beijing_001
```

### 7.2 åˆ—æ—è®¾è®¡åŸåˆ™

#### åŸåˆ™1ï¼šåˆ—æ—æ•°é‡è¦å°‘

```
âœ… æ¨èï¼š1-3ä¸ªåˆ—æ—
CREATE TABLE 'user', 'basic', 'contact'

âŒ ä¸æ¨èï¼šè¿‡å¤šåˆ—æ—
CREATE TABLE 'user', 'f1', 'f2', 'f3', 'f4', 'f5', ...
```

**åŸå› ï¼š**

- æ¯ä¸ªåˆ—æ—å¯¹åº”ä¸€ä¸ªStore
- è¿‡å¤šåˆ—æ—å¢åŠ RegionServerè´Ÿæ‹…
- å½±å“flushå’Œcompactionæ€§èƒ½

#### åŸåˆ™2ï¼šæŒ‰è®¿é—®é¢‘ç‡åˆ’åˆ†

```
CREATE TABLE 'article',
  {NAME => 'meta', TTL => 7776000},      # å…ƒæ•°æ®ï¼Œä¿ç•™90å¤©
  {NAME => 'content', TTL => 2592000}    # å†…å®¹ï¼Œä¿ç•™30å¤©
```

### 7.3 æ‰¹é‡æ“ä½œä¼˜åŒ–

```java
// âŒ é€æ¡æ’å…¥ï¼ˆæ…¢ï¼‰
for (int i = 0; i < 10000; i++) {
    Put put = new Put(Bytes.toBytes("row" + i));
    put.addColumn(...);
    table.put(put);  // æ¯æ¬¡éƒ½å‘é€è¯·æ±‚
}

// âœ… æ‰¹é‡æ’å…¥ï¼ˆå¿«ï¼‰
List<Put> puts = new ArrayList<>();
for (int i = 0; i < 10000; i++) {
    Put put = new Put(Bytes.toBytes("row" + i));
    put.addColumn(...);
    puts.add(put);
}
table.put(puts);  // ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰è¯·æ±‚
```

### 7.4 ç¼“å­˜ä¼˜åŒ–

```java
// è®¾ç½®Scanç¼“å­˜
Scan scan = new Scan();
scan.setCaching(1000);  // æ¯æ¬¡RPCè·å–1000è¡Œ
scan.setBatch(100);     // æ¯è¡Œæœ€å¤šè¿”å›100åˆ—

// ä½¿ç”¨BlockCache
HColumnDescriptor cf = new HColumnDescriptor("cf");
cf.setBlockCacheEnabled(true);  // å¯ç”¨BlockCache
cf.setInMemory(true);          // å¸¸é©»å†…å­˜ï¼ˆæ…ç”¨ï¼‰
```

### 7.5 é¢„åˆ†åŒºç­–ç•¥

```java
// åˆ›å»ºè¡¨æ—¶é¢„åˆ†åŒº
byte[][] splits = new byte[][] {
    Bytes.toBytes("row100"),
    Bytes.toBytes("row200"),
    Bytes.toBytes("row300"),
    ...
};
admin.createTable(tableDescriptor, splits);
```

**ä½œç”¨ï¼š**

- é¿å…Regionè‡ªåŠ¨åˆ†è£‚
- æ•°æ®å‡åŒ€åˆ†å¸ƒ
- æé«˜å¹¶å‘å†™å…¥æ€§èƒ½

### 7.6 Compactionç­–ç•¥

```xml
<!-- hbase-site.xmlé…ç½® -->

<!-- Minor Compactioné—´éš” -->
<property>
    <name>hbase.hregion.majorcompaction</name>
    <value>604800000</value>  <!-- 7å¤© -->
</property>

<!-- ç¦ç”¨è‡ªåŠ¨Major Compaction -->
<property>
    <name>hbase.hregion.majorcompaction</name>
    <value>0</value>
</property>
```

**æ‰‹åŠ¨è§¦å‘ï¼š**

```bash
# Minor Compaction
compact 'table_name'

# Major Compactionï¼ˆæ…ç”¨ï¼Œå½±å“æ€§èƒ½ï¼‰
major_compact 'table_name'
```

------

## ç¬¬å…«éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 8.1 è¿æ¥é—®é¢˜

#### é—®é¢˜1ï¼šæ— æ³•è¿æ¥ZooKeeper

**é”™è¯¯ä¿¡æ¯ï¼š**

```
org.apache.zookeeper.KeeperException$ConnectionLossException
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥ZooKeeperæ˜¯å¦å¯åŠ¨
zkServer.sh status

# 2. æ£€æŸ¥é˜²ç«å¢™
systemctl status firewalld
firewall-cmd --zone=public --add-port=2181/tcp --permanent

# 3. æ£€æŸ¥hostsæ–‡ä»¶
vim /etc/hosts
# ç¡®ä¿åŒ…å«ï¼š
192.168.128.131 slave1
192.168.128.132 slave2
192.168.128.133 slave3

# 4. éªŒè¯è¿æ¥
zkCli.sh -server slave1:2181
```

#### é—®é¢˜2ï¼šHBaseå¯åŠ¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**

```
HMaster: Failed to become active master
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
# 1. æ£€æŸ¥HDFSæ˜¯å¦å¯åŠ¨
hdfs dfsadmin -report

# 2. æ£€æŸ¥ZooKeeperè¿æ¥
hbase zkcli
ls /hbase

# 3. æ¸…ç†ZooKeeperä¸­çš„HBaseæ•°æ®
deleteall /hbase

# 4. é‡æ–°å¯åŠ¨HBase
stop-hbase.sh
start-hbase.sh
```

### 8.2 æ€§èƒ½é—®é¢˜

#### é—®é¢˜3ï¼šå†™å…¥é€Ÿåº¦æ…¢

**è¯Šæ–­ï¼š**

```bash
# æŸ¥çœ‹RegionServeræ—¥å¿—
tail -f $HBASE_HOME/logs/hbase-*-regionserver-*.log
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```java
// 1. å…³é—­WALï¼ˆé£é™©ï¼šæ•°æ®å¯èƒ½ä¸¢å¤±ï¼‰
Put put = new Put(Bytes.toBytes(rowKey));
put.setDurability(Durability.SKIP_WAL);

// 2. ä½¿ç”¨æ‰¹é‡æ’å…¥
List<Put> puts = new ArrayList<>();
// ... æ·»åŠ Put
table.put(puts);

// 3. å¢åŠ MemStoreå¤§å°
<property>
    <name>hbase.hregion.memstore.flush.size</name>
    <value>268435456</value>  <!-- 256MB -->
</property>
```

#### é—®é¢˜4ï¼šè¯»å–é€Ÿåº¦æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```java
// 1. ä½¿ç”¨Bloom Filter
HColumnDescriptor cf = new HColumnDescriptor("cf");
cf
```